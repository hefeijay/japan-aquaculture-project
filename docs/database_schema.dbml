// 日本陆上养殖项目数据库设计 - DBML定义
// 简化统一设备管理方案
// 更新日期: 2026-01-21
// 在线ER图: https://dbdiagram.io/

// ============================================================
// 核心业务模块 - Core Business
// ============================================================

Table ponds {
  id integer [pk, increment, note: '主键ID']
  pond_id varchar(128) [unique, not null, note: '养殖池业务ID（唯一标识符）']
  name varchar(128) [unique, not null, note: '养殖池名称']
  location varchar(255) [note: '位置信息']
  area float [note: '养殖池实际面积（平方米）']
  count integer [note: '当前虾数量（尾数）']
  description text [note: '描述/备注']
  created_at timestamp [default: `CURRENT_TIMESTAMP`, note: '创建时间']
  updated_at timestamp [default: `CURRENT_TIMESTAMP`, note: '更新时间']
  
  note: '养殖池信息表'
}

Table batches {
  id integer [pk, increment, note: '数据库主键']
  batch_id varchar(128) [unique, not null, note: '批次业务ID（唯一标识符，如：BATCH_2024_001）']
  pond_id integer [not null, ref: > ponds.id, note: '所属养殖池ID（FK）']
  species varchar(64) [not null, default: 'Litopenaeus vannamei', note: '物种（默认南美白对虾学名）']
  start_date date [not null, note: '开始日期']
  end_date date [note: '结束日期（可空）']
  location varchar(128) [note: '场地/车间位置']
  seed_origin varchar(128) [note: '苗种来源']
  stocking_density decimal(10,2) [note: '放养密度（尾/㎡或尾/m³）']
  notes text [note: '备注']
  created_at timestamp [default: `CURRENT_TIMESTAMP`, note: '创建时间']
  updated_at timestamp [default: `CURRENT_TIMESTAMP`, note: '更新时间']
  
  indexes {
    (pond_id, start_date, end_date) [name: 'idx_batches_pond_dates']
    (batch_id) [name: 'idx_batches_batch_id']
  }
  note: '批次信息表 - 存储养殖批次的基本信息'
}

// ============================================================
// 设备管理模块 - 统一设备架构
// ============================================================

Table device_types {
  id integer [pk, increment, note: '设备类型ID（数据库主键，自增）']
  category varchar(32) [not null, note: '设备大类（sensor=传感器/feeder=喂食机/camera=摄像头/water_pump=循环水泵/air_blower=鼓风机/water_switch=水龙头开关/solar_heater_pump=太阳能加热器循环泵）']
  name varchar(64) [unique, not null, note: '设备类型名称（中文，必填，唯一）']
  description text [note: '设备类型描述']
  created_at timestamp [default: `CURRENT_TIMESTAMP`, note: '创建时间']
  updated_at timestamp [default: `CURRENT_TIMESTAMP`, note: '更新时间']
  
  indexes {
    (category) [name: 'idx_device_type_category']
  }
  note: '设备类型字典表 - 初始数据：1-传感器, 2-喂食机, 3-摄像头, 4-循环水泵, 5-鼓风机, 6-水龙头开关, 7-太阳能加热器循环泵'
}

Table sensor_types {
  id integer [pk, increment, note: '传感器类型ID（数据库主键，自增）']
  type_name varchar(128) [unique, not null, note: '传感器类型名称（必填，唯一）']
  metric varchar(64) [unique, not null, note: 'metric标识符（do/water_level/PH/temperature/turbidity/ammonia/nitrite/circulation）']
  unit varchar(50) [note: '数据单位（mg/L/mm/pH/°C/NTU/unknown）']
  valid_min float [note: '有效值下限']
  valid_max float [note: '有效值上限']
  description text [note: '传感器类型描述/备注']
  created_at timestamp [default: `CURRENT_TIMESTAMP`, note: '创建时间']
  updated_at timestamp [default: `CURRENT_TIMESTAMP`, note: '更新时间']
  
  indexes {
    (metric) [name: 'idx_sensor_type_metric']
  }
  note: '传感器类型字典表 - 初始数据：1-溶解氧(do), 2-液位(water_level), 3-PH(PH), 4-温度(temperature), 5-浊度(turbidity), 6-氨氮(ammonia), 7-亚硝酸盐(nitrite), 8-循环(circulation)'
}

Table devices {
  id integer [pk, increment, note: '主键ID']
  device_id varchar(128) [unique, not null, note: '设备唯一标识符（如：feeder_124314, sensor_1343）']
  name varchar(128) [not null, note: '设备名称（必填）']
  ownership varchar(128) [not null, note: '设备归属']
  device_type_id integer [not null, ref: > device_types.id, note: '设备类型ID（FK → device_types.id）']
  sensor_type_id integer [ref: > sensor_types.id, note: '传感器类型ID（FK → sensor_types.id，仅当category=sensor时填写）']
  pond_id integer [ref: > ponds.id, note: '所属养殖池ID（FK）']
  location varchar(255) [note: '设备安装位置']
  model varchar(128) [note: '设备型号/规格']
  manufacturer varchar(128) [note: '制造商']
  serial_number varchar(128) [unique, note: '设备序列号']
  firmware_version varchar(64) [note: '固件版本']
  hardware_version varchar(64) [note: '硬件版本']
  ip_address varchar(45) [note: '设备IP地址']
  mac_address varchar(17) [note: 'MAC地址']
  status varchar(50) [not null, default: 'online', note: '设备状态（online=在线/offline=离线，默认：online）']
  control_mode varchar(20) [not null, default: 'hybrid', note: '控制权限模式（manual_only=仅人工/ai_only=仅AI/hybrid=人工+AI协同，默认：hybrid）']
  config_json json [note: '设备专属配置（JSON格式），不同设备类型存储不同字段，详见设计说明文档']
  tags varchar(255) [note: '设备标签（逗号分隔字符串）']
  description text [note: '设备描述信息']
  created_at timestamp [default: `CURRENT_TIMESTAMP`, note: '创建时间']
  updated_at timestamp [default: `CURRENT_TIMESTAMP`, note: '更新时间']
  
  indexes {
    (device_type_id, status) [name: 'idx_device_type_status']
    (sensor_type_id) [name: 'idx_device_sensor_type']
    (pond_id, status) [name: 'idx_device_pond_status']
    (status) [name: 'idx_device_status']
    (ownership) [name: 'idx_device_ownership']
  }
  note: '统一设备管理表 - 管理所有类型设备。sensor_type_id仅当设备为传感器时填写，设备专属配置统一存储在device_config JSON字段中'
}

// ============================================================
// 设备数据日志模块 - 直接关联devices.id
// ============================================================

Table sensor_readings {
  id bigint [pk, increment, note: '主键ID']
  device_id integer [not null, ref: > devices.id, note: '设备ID（FK → devices.id）']
  pond_id integer [not null, ref: > ponds.id, note: '所属养殖池ID（FK）- 快照字段，记录数据产生时的池位']
  batch_id integer [ref: > batches.id, note: '批次ID（FK，关联到batches.id主键）']
  
  // 读数数据
  value float [not null, note: '读数值']
  unit varchar(50) [note: '单位（%/mm/°C/NTU/mg/L等）']
  metric varchar(64) [note: 'metric标识符（快照字段，从sensor_types同步，便于查询）']
  description text [note: '描述']
  
  // 时间戳
  recorded_at timestamp [note: '数据记录时间']
  ts_utc datetime(3) [note: 'UTC时间戳（毫秒精度）']
  ts_local datetime(3) [note: '本地时间戳（日本时区）']
  
  // 质量控制
  quality_flag varchar(20) [not null, default: 'ok', note: '质量标记（ok/missing/anomaly）']
  checksum varchar(64) [note: '完整性校验']
  
  created_at timestamp [default: `CURRENT_TIMESTAMP`, note: '创建时间']
  updated_at timestamp [default: `CURRENT_TIMESTAMP`, note: '更新时间']
  
  indexes {
    (device_id, recorded_at) [name: 'idx_sensor_reading_device_ts']
    (pond_id, ts_utc) [name: 'idx_sensor_reading_pond_ts']
    (metric, ts_utc) [name: 'idx_sensor_reading_metric_ts']
    (batch_id, ts_utc) [name: 'idx_sensor_reading_batch_ts']
  }
  note: '传感器读数表 - 直接关联devices.id，metric为快照字段便于按类型查询'
}

Table feeder_logs {
  id bigint [pk, increment, note: '主键ID']
  device_id integer [not null, ref: > devices.id, note: '设备ID（FK → devices.id）']
  pond_id integer [not null, ref: > ponds.id, note: '所属养殖池ID（FK）- 快照字段，记录投喂时的池位']
  batch_id integer [ref: > batches.id, note: '批次ID（FK，关联到batches.id主键）']
  ts_utc datetime(3) [not null, note: 'UTC时间戳']
  ts_local datetime(3) [note: '本地时间戳']
  feed_amount_g decimal(12,3) [note: '投喂量（克）']
  run_time_s integer [note: '运行时长（秒）']
  status varchar(20) [not null, default: 'ok', note: '状态（ok/warning/error）']
  leftover_estimate_g decimal(12,3) [note: '剩余饵料估计（克）']
  notes text [note: '备注']
  checksum varchar(64) [note: '完整性校验']
  created_at timestamp [default: `CURRENT_TIMESTAMP`, note: '创建时间']
  updated_at timestamp [default: `CURRENT_TIMESTAMP`, note: '更新时间']
  
  indexes {
    (device_id, ts_utc) [name: 'idx_feeder_log_device_ts']
    (pond_id, ts_utc) [name: 'idx_feeder_log_pond_ts']
  }
  note: '喂食机运行记录表 - 直接关联devices.id'
}

Table camera_images {
  id bigint [pk, increment, note: '主键ID']
  device_id integer [not null, ref: > devices.id, note: '设备ID（FK → devices.id）']
  pond_id integer [not null, ref: > ponds.id, note: '所属养殖池ID（FK）- 快照字段']
  batch_id integer [ref: > batches.id, note: '批次ID（FK，关联到batches.id主键）']
  image_url varchar(500) [not null, note: '图片URL']
  storage_uri varchar(512) [note: '对象存储路径/URI']
  ts_utc datetime(3) [not null, note: 'UTC时间戳']
  ts_local datetime(3) [note: '本地时间戳（日本时区）']
  timestamp_str varchar(50) [default: '', note: '图片时间戳字符串']
  width integer [default: 1920, note: '图片宽度（像素）']
  height integer [default: 1080, note: '图片高度（像素）']
  format varchar(20) [default: 'jpg', note: '图片格式(jpg/png等)']
  size integer [default: 0, note: '图片大小(字节)']
  codec varchar(32) [note: '编解码']
  fps integer [default: 0, note: '帧率']
  quality_flag varchar(20) [not null, default: 'ok', note: '质量标记（ok/missing/anomaly）']
  checksum varchar(64) [note: '完整性校验']
  created_at timestamp [default: `CURRENT_TIMESTAMP`, note: '创建时间']
  updated_at timestamp [default: `CURRENT_TIMESTAMP`, note: '更新时间']
  
  indexes {
    (device_id, ts_utc) [name: 'idx_camera_image_device_ts']
    (pond_id, ts_utc) [name: 'idx_camera_image_pond_ts']
    (batch_id, ts_utc) [name: 'idx_camera_image_batch_ts']
  }
  note: '摄像头图片表 - 直接关联devices.id'
}

Table camera_health {
  id integer [pk, increment, note: '主键ID']
  device_id integer [not null, ref: > devices.id, note: '设备ID（FK → devices.id）']
  pond_id integer [not null, ref: > ponds.id, note: '所属养殖池ID（FK）- 快照字段']
  health_status varchar(50) [not null, note: '健康状态(优秀/良好/一般/需要维护/离线)']
  overall_score decimal(5,2) [not null, note: '总体健康分数(0-100)']
  connectivity_status varchar(50) [not null, note: '连通性检查状态']
  connectivity_score integer [not null, note: '连通性分数']
  connectivity_message varchar(500) [not null, note: '连通性检查消息']
  image_quality_status varchar(50) [not null, note: '图像质量检查状态']
  image_quality_score integer [not null, note: '图像质量分数']
  image_quality_message varchar(500) [not null, note: '图像质量检查消息']
  hardware_status varchar(50) [not null, note: '硬件检查状态']
  hardware_score integer [not null, note: '硬件分数']
  hardware_message varchar(500) [not null, note: '硬件检查消息']
  storage_status varchar(50) [not null, note: '存储检查状态']
  storage_score integer [not null, note: '存储分数']
  storage_message varchar(500) [not null, note: '存储检查消息']
  timestamp bigint [not null, note: '检查时间戳(毫秒)']
  last_check varchar(50) [not null, note: '最后检查时间字符串']
  temperature decimal(5,2) [note: '温度']
  uptime_hours integer [note: '运行时间(小时)']
  created_at timestamp [default: `CURRENT_TIMESTAMP`, note: '创建时间']
  updated_at timestamp [default: `CURRENT_TIMESTAMP`, note: '更新时间']
  
  indexes {
    (device_id, timestamp) [name: 'idx_camera_health_device_ts']
    (pond_id, timestamp) [name: 'idx_camera_health_pond_ts']
    (health_status) [name: 'idx_camera_health_status']
    (overall_score) [name: 'idx_ch_overall_score']
  }
  note: '摄像头健康检查表 - 直接关联devices.id'
}

// ============================================================
// 图像分析模块 - Image Analysis
// ============================================================

Table shrimp_stats {
  id bigint [pk, increment, note: '主键ID']
  frame_id bigint [ref: > camera_images.id, note: '图像帧ID（FK -> camera_images）']
  batch_id integer [ref: > batches.id, note: '批次ID（FK，关联到batches.id主键）']
  ts_utc datetime(3) [not null, note: 'UTC时间戳（推理时间）']
  uuid varchar(36) [note: 'UUID']
  pond_id integer [not null, ref: > ponds.id, note: '所属养殖池ID（FK）']
  input_subdir varchar(255) [note: '输入子目录']
  output_dir varchar(512) [note: '输出目录']
  created_at_source_iso varchar(64) [note: '源创建时间ISO']
  created_at_source timestamp [note: '源创建时间']
  conf float [note: '置信度（原有字段）']
  confidence_avg decimal(5,4) [note: '平均置信度']
  iou float [note: 'IOU']
  total_live integer [note: '活虾总数']
  count integer [note: '检测数量']
  total_dead integer [note: '死虾总数']
  size_min_cm float [note: '最小尺寸(cm)']
  size_max_cm float [note: '最大尺寸(cm)']
  size_mean_cm float [note: '平均尺寸(cm)']
  size_median_cm float [note: '中位数尺寸(cm)']
  avg_length_mm decimal(12,3) [note: '平均长度（毫米）']
  avg_height_mm decimal(12,3) [note: '平均高度（毫米）']
  weight_min_g float [note: '最小体重(g)']
  weight_max_g float [note: '最大体重(g)']
  weight_mean_g float [note: '平均体重(g)']
  weight_median_g float [note: '中位数体重(g)']
  est_weight_g_avg decimal(12,3) [note: '平均估算体重（克）']
  feed_present boolean [default: false, note: '是否存在饲料']
  shrimp_shell_present boolean [default: false, note: '是否存在虾皮']
  model_name varchar(128) [note: '模型名称']
  model_version varchar(64) [note: '模型版本']
  notes text [note: '备注']
  source_file varchar(512) [note: '源文件']
  created_at timestamp [default: `CURRENT_TIMESTAMP`, note: '创建时间']
  updated_at timestamp [default: `CURRENT_TIMESTAMP`, note: '更新时间']
  
  indexes {
    (frame_id) [name: 'idx_ss_frame']
    (ts_utc) [name: 'idx_ss_ts']
    (pond_id, ts_utc) [name: 'idx_shrimp_stats_pond_ts']
    (batch_id, ts_utc) [name: 'idx_ss_batch_ts']
    (model_name, model_version) [name: 'idx_id_modelver']
  }
  note: '图像识别统计结果表'
}

// ============================================================
// 操作日志模块 - Operation Logs
// ============================================================

Table operations_logs {
  id bigint [pk, increment, note: '主键ID']
  user_id integer [not null, ref: > user.id, note: '操作用户ID（FK → user.id）']
  batch_id integer [ref: > batches.id, note: '批次ID（FK，关联到batches.id主键）']
  pond_id integer [ref: > ponds.id, note: '所属养殖池ID（FK）']
  ts_utc datetime(3) [not null, note: 'UTC时间戳']
  ts_local datetime(3) [note: '本地时间戳']
  action_type varchar(64) [not null, note: '操作类型（投料/水质调控/巡检/清洗等）']
  remarks text [note: '备注']
  attachment_uri varchar(512) [note: '附件URI']
  created_at timestamp [default: `CURRENT_TIMESTAMP`, note: '创建时间']
  updated_at timestamp [default: `CURRENT_TIMESTAMP`, note: '更新时间']
  
  indexes {
    (user_id, ts_utc) [name: 'idx_ol_user_ts']
    (batch_id, ts_utc) [name: 'idx_ol_batch_ts']
    (pond_id, ts_utc) [name: 'idx_ol_pond_ts']
  }
  note: '人工操作日志表'
}

Table history_records {
  id bigint [pk, increment, note: '主键ID']
  batch_id bigint [note: '批次ID']
  metric_name varchar(64) [not null, note: '指标名称']
  value varchar(128) [not null, note: '值（文本存储）']
  unit varchar(16) [note: '单位']
  ts_utc datetime(3) [note: 'UTC时间戳']
  ts_local datetime(3) [note: '本地时间戳']
  notes text [note: '备注']
  created_at timestamp [default: `CURRENT_TIMESTAMP`, note: '创建时间']
  updated_at timestamp [default: `CURRENT_TIMESTAMP`, note: '更新时间']
  
  indexes {
    (batch_id, metric_name, ts_utc) [name: 'idx_hr_batch_metric_ts']
  }
  note: '往期养殖记录表（结构化）'
}

// ============================================================
// AI决策模块 - AI Decision
// ============================================================

Table ai_decisions {
  id integer [pk, increment, note: '主键ID']
  decision_id varchar(64) [unique, not null, note: '决策唯一标识']
  type varchar(50) [not null, note: '消息类型：analysis-分析, warning-警告, action-操作, optimization-优化']
  message text [not null, note: '决策消息内容']
  action text [note: '建议操作内容']
  source varchar(100) [note: '数据源类型(sensor/device/system/manual)']
  source_id varchar(100) [note: '数据源具体ID']
  priority integer [default: 0, note: '优先级(0-10，数字越大优先级越高)']
  confidence decimal(5,2) [default: 0, note: 'AI决策置信度(0-100)']
  status varchar(50) [not null, default: 'active', note: '状态：active-活跃, processed-已处理, expired-已过期']
  expires_at timestamp [note: '过期时间']
  created_at timestamp [default: `CURRENT_TIMESTAMP`, note: '创建时间']
  updated_at timestamp [default: `CURRENT_TIMESTAMP`, note: '更新时间']
  
  indexes {
    (type) [name: 'idx_type']
    (status) [name: 'idx_status']
    (priority) [name: 'idx_priority']
    (source, source_id) [name: 'idx_source']
    (created_at) [name: 'idx_created_at']
    (expires_at) [name: 'idx_expires_at']
  }
  note: 'AI决策消息模型 - 存储AI系统生成的各类决策消息'
}

Table message_types {
  id integer [pk, increment, note: '主键ID']
  type varchar(50) [unique, not null, note: '消息类型标识']
  icon varchar(10) [not null, note: '消息图标(emoji)']
  color varchar(20) [not null, note: '消息颜色(hex或颜色名)']
  description varchar(255) [note: '消息类型描述']
  is_active boolean [default: true, note: '是否启用该消息类型']
  created_at timestamp [default: `CURRENT_TIMESTAMP`, note: '创建时间']
  updated_at timestamp [default: `CURRENT_TIMESTAMP`, note: '更新时间']
  
  note: '消息类型配置模型 - 定义不同类型消息的显示样式和属性'
}

Table decision_rules {
  id integer [pk, increment, note: '主键ID']
  rule_id varchar(64) [unique, not null, note: '规则唯一标识']
  name varchar(255) [not null, note: '规则名称']
  condition_type varchar(50) [not null, note: '条件类型(sensor/device/time/manual)']
  condition_config text [note: '条件配置(JSON格式)']
  message_template text [not null, note: '消息模板，支持变量替换']
  action_template text [note: '操作模板，支持变量替换']
  decision_type varchar(50) [not null, note: '决策类型(analysis/warning/action/optimization)']
  priority integer [default: 0, note: '规则优先级(0-10)']
  is_active boolean [default: true, note: '是否启用该规则']
  created_at timestamp [default: `CURRENT_TIMESTAMP`, note: '创建时间']
  updated_at timestamp [default: `CURRENT_TIMESTAMP`, note: '更新时间']
  
  indexes {
    (condition_type) [name: 'idx_condition_type']
    (decision_type) [name: 'idx_decision_type']
    (priority) [name: 'idx_priority']
    (is_active) [name: 'idx_is_active']
  }
  note: 'AI决策规则模型 - 定义触发AI决策的条件和规则'
}

// ============================================================
// 用户系统模块 - User System
// ============================================================

Table user {
  id integer [pk, increment, note: '主键ID']
  user_id varchar(128) [unique, not null, note: '用户唯一标识ID']
  username varchar(128) [unique, not null, note: '用户名（唯一）']
  password_hash varchar(128) [not null, note: '密码哈希值']
  role varchar(128) [not null, note: '角色（admin=管理员/employee=员工/user=普通用户）']
  email varchar(255) [unique, note: '邮箱（唯一）']
  phone varchar(32) [unique, note: '电话（唯一）']
  status varchar(50) [not null, default: 'active', note: '状态（active/inactive/suspended）']
  created_at timestamp [default: `CURRENT_TIMESTAMP`, note: '创建时间']
  updated_at timestamp [default: `CURRENT_TIMESTAMP`, note: '更新时间']
  
  indexes {
    (user_id) [name: 'idx_user_user_id']
    (username) [name: 'idx_user_username']
    (email) [name: 'idx_user_email']
    (status) [name: 'idx_user_status']
  }
  note: '用户表 - 通过role字段区分管理员/员工/普通用户'
}

Table session {
  id integer [pk, increment, note: '主键ID']
  session_id varchar(128) [unique, not null, note: '会话唯一标识ID']
  user_id varchar(128) [not null, note: '用户ID']
  session_name varchar(128) [default: 'new chat', note: '会话名称']
  config text [note: '会话配置']
  summary varchar(2048) [note: '会话摘要']
  status varchar(50) [default: 'deactive', note: '状态（active/deactive）']
  create_at timestamp [default: `CURRENT_TIMESTAMP`, note: '创建时间']
  updated_at timestamp [default: `CURRENT_TIMESTAMP`, note: '更新时间']
  
  indexes {
    (session_id) [name: 'idx_session_id']
  }
  note: '会话表'
}

Table chat_history {
  id integer [pk, increment, note: '主键ID']
  session_id varchar(128) [not null, note: '会话ID']
  message_id varchar(128) [note: '消息唯一ID']
  role varchar(32) [note: '角色（user/assistant/system）']
  content text [note: '消息内容']
  type varchar(50) [note: '消息类型']
  tool_calls text [note: '工具调用（JSON）']
  meta_data text [note: '元数据（JSON）']
  status varchar(50) [default: 'active', note: '状态']
  timestamp timestamp [default: `CURRENT_TIMESTAMP`, note: '时间戳']
  updated_at timestamp [default: `CURRENT_TIMESTAMP`, note: '更新时间']
  
  indexes {
    (session_id) [name: 'idx_session_id']
  }
  note: '聊天历史表'
}

// ============================================================
// 任务系统模块 - Task System
// ============================================================

Table agent_task {
  id bigint [pk, increment, note: '主键ID']
  task_id varchar(255) [unique, not null, note: '任务唯一标识']
  session_id varchar(255) [note: '会话ID']
  parent_task_id varchar(255) [note: '父任务ID']
  goal text [not null, note: '任务目标']
  input_params json [note: '输入参数']
  result json [note: '执行结果']
  error_message text [note: '错误消息']
  logs text [note: '日志']
  tool_calls json [note: '工具调用']
  token_usage integer [note: 'Token使用量']
  status varchar(50) [not null, default: 'pending', note: '状态（pending/processing/completed/failed）']
  priority integer [default: 0, note: '优先级']
  completed_at timestamp [note: '完成时间']
  created_at timestamp [default: `CURRENT_TIMESTAMP`, note: '创建时间']
  updated_at timestamp [default: `CURRENT_TIMESTAMP`, note: '更新时间']
  
  indexes {
    (task_id) [name: 'idx_task_id']
    (session_id) [name: 'idx_session_id']
    (parent_task_id) [name: 'idx_parent_task_id']
    (status) [name: 'idx_status']
  }
  note: '大模型Agent运行的任务表'
}

Table tasks {
  id integer [pk, increment, note: '主键ID']
  task_id varchar(64) [unique, not null, note: '任务唯一标识']
  topic varchar(255) [not null, note: '任务主题']
  tool_name varchar(255) [not null, note: '工具名称']
  mode varchar(64) [not null, note: '模式']
  request text [not null, note: '请求内容']
  status varchar(64) [not null, note: '状态']
  response text [note: '响应内容']
  created_at timestamp [default: `CURRENT_TIMESTAMP`, note: '创建时间']
  updated_at timestamp [default: `CURRENT_TIMESTAMP`, note: '更新时间']
  completed_at timestamp [note: '完成时间']
  
  indexes {
    (task_id) [name: 'idx_task_id']
    (topic) [name: 'idx_topic']
  }
  note: '任务表 - 用于工具调用任务管理'
}

Table message_queue {
  id integer [pk, increment, note: '主键ID']
  message_id varchar(128) [unique, not null, note: '消息唯一标识']
  content text [not null, note: '消息内容']
  message_metadata text [note: '消息元数据(JSON格式)']
  message_type varchar(50) [not null, default: 'general', note: '消息类型(sensor_data/user_input/system_alert/general)']
  priority integer [not null, default: 5, note: '消息优先级(0-10)']
  status varchar(50) [not null, default: 'pending', note: '消息状态：pending/processing/completed/failed/expired']
  retry_count integer [not null, default: 0, note: '重试次数']
  max_retries integer [not null, default: 3, note: '最大重试次数']
  error_message text [note: '错误信息']
  consumed_at timestamp [note: '开始处理时间']
  completed_at timestamp [note: '处理完成时间']
  expires_at timestamp [note: '消息过期时间']
  created_at timestamp [default: `CURRENT_TIMESTAMP`, note: '消息接收时间']
  updated_at timestamp [default: `CURRENT_TIMESTAMP`, note: '更新时间']
  
  indexes {
    (status) [name: 'idx_status']
    (priority) [name: 'idx_priority']
    (message_type) [name: 'idx_message_type']
    (created_at) [name: 'idx_created_at']
    (consumed_at) [name: 'idx_consumed_at']
  }
  note: '消息队列模型 - 存储待处理的消息'
}

// ============================================================
// 知识库模块 - Knowledge Base
// ============================================================

Table knowledge_bases {
  id integer [pk, increment, note: '自增主键ID']
  knowledge_base_id varchar(36) [unique, not null, note: '知识库唯一标识ID']
  knowledge_base_name varchar(255) [not null, note: '知识库名称']
  description varchar(1024) [note: '知识库描述']
  created_at timestamp [default: `CURRENT_TIMESTAMP`, note: '创建时间']
  updated_at timestamp [default: `CURRENT_TIMESTAMP`, note: '更新时间']
  
  indexes {
    (knowledge_base_id) [name: 'idx_kb_id']
    (knowledge_base_name) [name: 'idx_name']
  }
  note: '知识库表 - 存储知识库的基本信息'
}

Table knowledge_documents {
  id integer [pk, increment, note: '自增主键ID']
  knowledge_base_id varchar(36) [not null, ref: > knowledge_bases.knowledge_base_id, note: '所属知识库ID（FK）']
  document_name varchar(512) [not null, note: '文档名称']
  document_path varchar(1024) [note: '文档存储路径']
  document_type varchar(50) [note: '文档类型：txt, pdf, docx 等']
  file_size integer [note: '文件大小（字节）']
  created_at timestamp [default: `CURRENT_TIMESTAMP`, note: '创建时间']
  updated_at timestamp [default: `CURRENT_TIMESTAMP`, note: '更新时间']
  
  indexes {
    (knowledge_base_id) [name: 'idx_kb_id']
    (document_name) [name: 'idx_doc_name']
  }
  note: '知识库文档表 - 存储知识库中的文档信息'
}

Table manuals_docs {
  id bigint [pk, increment, note: '主键ID']
  doc_uri varchar(512) [not null, note: '文档URI']
  version varchar(64) [note: '版本']
  source varchar(64) [note: '来源']
  notes text [note: '备注']
  created_at timestamp [default: `CURRENT_TIMESTAMP`, note: '创建时间']
  updated_at timestamp [default: `CURRENT_TIMESTAMP`, note: '更新时间']
  
  indexes {
    (version) [name: 'idx_md_version']
    (created_at) [name: 'idx_md_created']
  }
  note: '养殖手册/文档索引表'
}

// ============================================================
// 配置模块 - Configuration
// ============================================================

Table tools {
  id integer [pk, increment, note: '主键ID']
  tool_id varchar(36) [unique, not null, note: '工具唯一标识ID']
  name varchar(255) [unique, not null, note: '工具名称']
  description varchar(1024) [not null, note: '工具描述']
  type varchar(50) [not null, note: '工具类型']
  mode varchar(50) [not null, note: '工具模式']
  location text [note: '工具的位置信息，例如模块名和函数名']
  schema_def text [note: '工具的参数定义']
  ownership varchar(50) [not null, default: 'default', note: '所有权']
  
  note: '工具表'
}

Table prompts {
  id integer [pk, increment, note: '主键ID']
  agent_name varchar(255) [not null, note: '智能体名称']
  template_key varchar(255) [note: '模板键，用于区分同一智能体的不同模板']
  description text [note: '模板描述']
  version varchar(50) [note: '模板版本']
  template text [not null, note: '提示模板内容']
  created_at timestamp [default: `CURRENT_TIMESTAMP`, note: '创建时间']
  updated_at timestamp [default: `CURRENT_TIMESTAMP`, note: '更新时间']
  
  indexes {
    (agent_name) [name: 'idx_prompt_agent']
    (agent_name, template_key) [unique, name: 'uq_agent_name_template_key']
  }
  note: 'Prompt模型 - 用于存储和管理所有AI智能体的提示（Prompt）模板'
}

Table models {
  id integer [pk, increment, note: '自增主键ID']
  model_id varchar(36) [unique, not null, note: '模型唯一标识ID']
  model_name varchar(255) [not null, note: '模型名称，如 gpt-4o, gpt-4o-mini']
  description varchar(1024) [not null, note: '模型描述']
  status varchar(50) [not null, default: 'activate', note: '模型状态：activate, deactivate']
  perm varchar(50) [not null, default: 'public', note: '权限类型：public, private']
  created_at timestamp [default: `CURRENT_TIMESTAMP`, note: '创建时间']
  updated_at timestamp [default: `CURRENT_TIMESTAMP`, note: '更新时间']
  
  indexes {
    (model_id) [name: 'idx_model_id']
    (status) [name: 'idx_status']
  }
  note: 'AI模型表 - 存储可用的AI模型信息'
}

Table topic_memory {
  id integer [pk, increment, note: '自增主键ID']
  topic_id varchar(128) [unique, not null, note: '主题唯一标识ID']
  topic_name varchar(255) [not null, note: '归类的主题名称']
  topic_content text [note: '总结的主题内容描述']
  related_tags text [note: '该主题的关键标签，多个标签用逗号分隔']
  session_id varchar(128) [not null, note: '创建该主题的会话ID']
  status varchar(50) [default: 'active', note: '主题状态：active-活跃，inactive-非活跃，deleted-已删除']
  create_time timestamp [default: `CURRENT_TIMESTAMP`, note: '主题最初创建时间']
  update_time timestamp [default: `CURRENT_TIMESTAMP`, note: '主题最新更新时间']
  
  indexes {
    (topic_id) [name: 'idx_topic_id']
    (session_id) [name: 'idx_session_id']
    (create_time) [name: 'idx_create_time']
    (update_time) [name: 'idx_update_time']
  }
  note: '话题记忆表 - 用于存储海马体式的分类记忆用户聊天话题主题'
}

// ============================================================
// 设计说明 - Notes
// ============================================================
// 更新日期：2026-01-21
// 
// 核心改进：
// 1. ✅ 删除扩展表：移除sensors/feeders/cameras三张扩展表
// 2. ✅ 统一设备管理：所有设备信息存储在devices表
// 3. ✅ 直接关联：所有日志表直接关联devices.id
// 4. ✅ 灵活配置：设备专属配置统一存储在device_config JSON字段
// 5. ✅ 类型管理：通过device_types和sensor_types字典表管理设备类型
//
// 设备类型初始数据(device_types)：
// 1. sensor - 传感器
// 2. feeder - 喂食机
// 3. camera - 摄像头
// 4. water_pump - 循环水泵
// 5. air_blower - 鼓风机
// 6. water_switch - 水龙头开关
// 7. solar_heater_pump - 太阳能加热器循环泵
//
// 传感器类型初始数据(sensor_types)：
// 1. dissolved_oxygen_aturation - do - mg/L - 溶解氧饱和度
// 2. liquid_level - water_level - mm - 液位
// 3. PH - PH - pH - PH
// 4. temperature - temperature - °C - 温度
// 5. turbidity - turbidity - NTU - 浊度
// 6. ammonia - ammonia - mg/L - 氨氮浓度
// 7. nitrite - nitrite - mg/L - 亚硝酸盐浓度
// 8. circulation - circulation - unknown - 循环
//
// device_config JSON配置示例：
// 喂食机: {"feed_count": 1, "timezone": 9, "network_type": 0, "group_id": "xxx", "feed_portion_weight": 17.0, "capacity_kg": 50, "feed_type": "颗粒饲料"}
// 摄像头: {"quality": "高", "resolution": "1920x1080"}
// 循环水泵: {"circulation_volume": 60, "power": 750}
// 鼓风机: {"air_volume": 80, "power": 450}
// 太阳能加热器循环泵: {"circulation_volume": 45, "power": 500}
// 水龙头开关: {} (暂无特殊配置)
