// 日本陆上养殖项目数据库设计 - DBML定义
// 基于"方案一：统一设备管理"优化方案
// 生成日期: 2026-01-07
// 在线ER图: https://dbdiagram.io/

// ============================================================
// 核心业务模块 - Core Business
// ============================================================

Table ponds {
  id integer [pk, increment, note: '主键ID']
  name varchar(128) [unique, not null, note: '养殖池名称']
  location varchar(255) [note: '位置信息']
  area float [note: '养殖池实际面积（平方米）']
  shrimp_count integer [note: '当前虾数量（尾数）']
  description text [note: '描述/备注']
  created_at timestamp [default: `CURRENT_TIMESTAMP`, note: '创建时间']
  updated_at timestamp [default: `CURRENT_TIMESTAMP`, note: '更新时间']
  
  indexes {
    (name) [name: 'idx_pond_name']
  }
  note: '养殖池信息表'
}

Table batches {
  batch_id bigint [pk, increment, note: '批次ID（主键）']
  pond_id integer [not null, ref: > ponds.id, note: '所属养殖池ID（FK）']
  species varchar(64) [not null, default: 'Litopenaeus vannamei', note: '物种（默认南美白对虾学名）']
  start_date date [not null, note: '开始日期']
  end_date date [note: '结束日期（可空）']
  location varchar(128) [note: '场地/车间位置']
  seed_origin varchar(128) [note: '苗种来源']
  stocking_density decimal(10,2) [note: '放养密度（尾/㎡或尾/m³）']
  notes text [note: '备注']
  status varchar(50) [not null, default: 'active', note: '状态（active=进行中/completed=已完成/cancelled=已取消）']
  created_at timestamp [default: `CURRENT_TIMESTAMP`, note: '创建时间']
  updated_at timestamp [default: `CURRENT_TIMESTAMP`, note: '更新时间']
  
  indexes {
    (pond_id, start_date, end_date) [name: 'idx_batches_pond_dates']
    (status) [name: 'idx_batch_status']
  }
  note: '批次信息表 - 存储养殖批次的基本信息'
}

// ============================================================
// 设备管理模块 - Device Management (统一设备架构)
// ============================================================

Table device_types {
  id integer [pk, increment, note: '主键ID']
  category varchar(32) [not null, note: '设备大类（sensor/feeder/camera/actuator）']
  name varchar(64) [unique, not null, note: '设备类型名称']
  type_code varchar(64) [unique, not null, note: '设备类型代码']
  description text [note: '设备类型描述']
  created_at timestamp [default: `CURRENT_TIMESTAMP`, note: '创建时间']
  updated_at timestamp [default: `CURRENT_TIMESTAMP`, note: '更新时间']
  
  indexes {
    (category) [name: 'idx_device_type_category']
  }
  note: '设备类型表 - 定义设备类型和大类，简化结构避免过度设计'
}

Table devices {
  id integer [pk, increment, note: '主键ID']
  device_id varchar(128) [unique, not null, note: '设备唯一标识符 (UUID/SN)']
  name varchar(128) [not null, note: '设备名称']
  description text [note: '设备描述信息']
  ownership varchar(128) [not null, note: '设备归属']
  device_type_id integer [not null, ref: > device_types.id, note: '设备类型ID（FK）- 通过device_types.category字段可获取设备大类']
  pond_id integer [ref: > ponds.id, note: '所属养殖池ID（FK）']
  model varchar(128) [note: '设备型号/规格']
  manufacturer varchar(128) [note: '制造商']
  serial_number varchar(128) [unique, note: '设备序列号']
  location varchar(255) [note: '设备安装位置']
  firmware_version varchar(64) [note: '固件版本']
  hardware_version varchar(64) [note: '硬件版本']
  ip_address varchar(45) [note: '设备IP地址']
  mac_address varchar(17) [note: 'MAC地址']
  config_json json [note: '设备配置参数']
  tags json [note: '设备标签（JSON数组）']
  installed_at timestamp [note: '安装时间']
  last_maintenance_at timestamp [note: '最后维护时间']
  next_maintenance_at timestamp [note: '下次维护时间']
  warranty_expires_at timestamp [note: '保修到期时间']
  retired_at timestamp [note: '设备退役时间']
  status varchar(50) [not null, default: 'active', note: '设备状态（active/inactive/maintenance/retired/error）']
  is_online boolean [not null, default: false, note: '是否在线']
  control_mode varchar(20) [not null, default: 'hybrid', note: '控制权限模式（manual_only=仅人工/ai_only=仅AI/hybrid=人工+AI协同）']
  created_at timestamp [default: `CURRENT_TIMESTAMP`, note: '创建时间']
  updated_at timestamp [default: `CURRENT_TIMESTAMP`, note: '更新时间']
  
  indexes {
    (device_id) [name: 'idx_device_id']
    (device_type_id, status) [name: 'idx_device_type_status']
    (pond_id, status) [name: 'idx_device_pond_status']
    (control_mode) [name: 'idx_device_control_mode']
  }
  note: '统一设备管理表 - 管理所有类型的设备。设备大类通过device_types.category字段获取'
}

// ============================================================
// 传感器扩展模块 - Sensor Extension
// ============================================================

Table sensor_types {
  id integer [pk, increment, note: '主键ID']
  type_name varchar(128) [unique, not null, note: '类型名称（如：溶解氧饱和度）']
  metric varchar(64) [unique, not null, note: 'metric 标识符（do/ph/temperature/turbidity）- 必填，用于路由数据到对应读数表']
  unit varchar(50) [note: '数据单位（%/mm/°C/NTU）']
  valid_min float [note: '有效值下限']
  valid_max float [note: '有效值上限']
  description text [note: '描述/备注']
  created_at timestamp [default: `CURRENT_TIMESTAMP`, note: '创建时间']
  updated_at timestamp [default: `CURRENT_TIMESTAMP`, note: '更新时间']
  
  indexes {
    (metric) [name: 'idx_sensor_type_metric']
  }
  note: '传感器测量类型表 - 定义传感器的测量指标'
}

Table sensors {
  id integer [pk, increment, note: '主键ID']
  device_id integer [unique, not null, ref: > devices.id, note: '关联设备ID（FK）- 一对一关系，通过此ID关联获取name/pond_id/status/model等基础信息']
  sensor_type_id integer [not null, ref: > sensor_types.id, note: '传感器类型ID（FK）']
  calibration_date timestamp [note: '最后校准日期']
  calibration_interval_days integer [default: 90, note: '校准周期（天）']
  created_at timestamp [default: `CURRENT_TIMESTAMP`, note: '创建时间']
  updated_at timestamp [default: `CURRENT_TIMESTAMP`, note: '更新时间']
  
  indexes {
    (device_id) [name: 'idx_sensor_device']
    (sensor_type_id) [name: 'idx_sensor_type']
  }
  note: '传感器扩展表 - 只存储传感器特有信息。name/pond_id/status/model等基础信息通过device_id从devices表JOIN获取'
}

// 溶解氧饱和度读数表
Table dissolved_oxygen_saturation_readings {
  id bigint [pk, increment, note: '主键ID']
  sensor_id integer [not null, ref: > sensors.id, note: '传感器设备ID（FK）']
  pond_id integer [not null, ref: > ponds.id, note: '所属养殖池ID（FK）- 快照字段，记录数据产生时的池位']
  batch_id bigint [ref: > batches.batch_id, note: '批次ID（FK）']
  value float [not null, note: '溶解氧饱和度值']
  metric varchar(32) [default: 'dissolved_oxygen_saturation', note: '指标标识']
  unit varchar(20) [default: '%', note: '单位']
  description text [note: '描述']
  ts_utc datetime(3) [not null, note: 'UTC时间戳（毫秒精度）']
  ts_local datetime(3) [note: '本地时间戳（日本时区）']
  recorded_at timestamp [note: '数据记录时间（兼容字段）']
  quality_flag varchar(20) [not null, default: 'ok', note: '质量标记（ok/missing/anomaly）']
  checksum varchar(64) [note: '完整性校验']
  created_at timestamp [default: `CURRENT_TIMESTAMP`, note: '创建时间']
  updated_at timestamp [default: `CURRENT_TIMESTAMP`, note: '更新时间']
  
  indexes {
    (sensor_id, ts_utc) [name: 'idx_do_sat_sensor_ts']
    (pond_id, ts_utc) [name: 'idx_do_sat_pond_ts']
    (batch_id, ts_utc) [name: 'idx_do_sat_batch_ts']
  }
  note: '溶解氧饱和度读数表 - 存储溶解氧饱和度传感器的测量数据'
}

// pH值读数表
Table ph_readings {
  id bigint [pk, increment, note: '主键ID']
  sensor_id integer [not null, ref: > sensors.id, note: '传感器设备ID（FK）']
  pond_id integer [not null, ref: > ponds.id, note: '所属养殖池ID（FK）- 快照字段，记录数据产生时的池位']
  batch_id bigint [ref: > batches.batch_id, note: '批次ID（FK）']
  value float [not null, note: 'pH值']
  metric varchar(32) [default: 'ph', note: '指标标识']
  unit varchar(20) [note: '单位']
  description text [note: '描述']
  ts_utc datetime(3) [not null, note: 'UTC时间戳（毫秒精度）']
  ts_local datetime(3) [note: '本地时间戳（日本时区）']
  recorded_at timestamp [note: '数据记录时间（兼容字段）']
  quality_flag varchar(20) [not null, default: 'ok', note: '质量标记（ok/missing/anomaly）']
  checksum varchar(64) [note: '完整性校验']
  created_at timestamp [default: `CURRENT_TIMESTAMP`, note: '创建时间']
  updated_at timestamp [default: `CURRENT_TIMESTAMP`, note: '更新时间']
  
  indexes {
    (sensor_id, ts_utc) [name: 'idx_ph_sensor_ts']
    (pond_id, ts_utc) [name: 'idx_ph_pond_ts']
    (batch_id, ts_utc) [name: 'idx_ph_batch_ts']
  }
  note: 'pH值读数表 - 存储pH传感器的测量数据'
}

// 温度读数表
Table temperature_readings {
  id bigint [pk, increment, note: '主键ID']
  sensor_id integer [not null, ref: > sensors.id, note: '传感器设备ID（FK）']
  pond_id integer [not null, ref: > ponds.id, note: '所属养殖池ID（FK）- 快照字段，记录数据产生时的池位']
  batch_id bigint [ref: > batches.batch_id, note: '批次ID（FK）']
  value float [not null, note: '温度值']
  metric varchar(32) [default: 'temperature', note: '指标标识']
  unit varchar(20) [default: '°C', note: '单位（°C/°F）']
  description text [note: '描述']
  ts_utc datetime(3) [not null, note: 'UTC时间戳（毫秒精度）']
  ts_local datetime(3) [note: '本地时间戳（日本时区）']
  recorded_at timestamp [note: '数据记录时间（兼容字段）']
  quality_flag varchar(20) [not null, default: 'ok', note: '质量标记（ok/missing/anomaly）']
  checksum varchar(64) [note: '完整性校验']
  created_at timestamp [default: `CURRENT_TIMESTAMP`, note: '创建时间']
  updated_at timestamp [default: `CURRENT_TIMESTAMP`, note: '更新时间']
  
  indexes {
    (sensor_id, ts_utc) [name: 'idx_temp_sensor_ts']
    (pond_id, ts_utc) [name: 'idx_temp_pond_ts']
    (batch_id, ts_utc) [name: 'idx_temp_batch_ts']
  }
  note: '温度读数表 - 存储温度传感器的测量数据'
}

// 液位读数表
Table liquid_level_readings {
  id bigint [pk, increment, note: '主键ID']
  sensor_id integer [not null, ref: > sensors.id, note: '传感器设备ID（FK）']
  pond_id integer [not null, ref: > ponds.id, note: '所属养殖池ID（FK）- 快照字段，记录数据产生时的池位']
  batch_id bigint [ref: > batches.batch_id, note: '批次ID（FK）']
  value float [not null, note: '液位值']
  metric varchar(32) [default: 'liquid_level', note: '指标标识']
  unit varchar(20) [default: 'mm', note: '单位（mm/cm/m）']
  description text [note: '描述']
  ts_utc datetime(3) [not null, note: 'UTC时间戳（毫秒精度）']
  ts_local datetime(3) [note: '本地时间戳（日本时区）']
  recorded_at timestamp [note: '数据记录时间（兼容字段）']
  quality_flag varchar(20) [not null, default: 'ok', note: '质量标记（ok/missing/anomaly）']
  checksum varchar(64) [note: '完整性校验']
  created_at timestamp [default: `CURRENT_TIMESTAMP`, note: '创建时间']
  updated_at timestamp [default: `CURRENT_TIMESTAMP`, note: '更新时间']
  
  indexes {
    (sensor_id, ts_utc) [name: 'idx_liquid_level_sensor_ts']
    (pond_id, ts_utc) [name: 'idx_liquid_level_pond_ts']
    (batch_id, ts_utc) [name: 'idx_liquid_level_batch_ts']
  }
  note: '液位读数表 - 存储液位传感器的测量数据'
}

// 浊度读数表
Table turbidity_readings {
  id bigint [pk, increment, note: '主键ID']
  sensor_id integer [not null, ref: > sensors.id, note: '传感器设备ID（FK）']
  pond_id integer [not null, ref: > ponds.id, note: '所属养殖池ID（FK）- 快照字段，记录数据产生时的池位']
  batch_id bigint [ref: > batches.batch_id, note: '批次ID（FK）']
  value float [not null, note: '浊度值']
  metric varchar(32) [default: 'turbidity', note: '指标标识']
  unit varchar(20) [default: 'NTU', note: '单位（NTU）']
  description text [note: '描述']
  ts_utc datetime(3) [not null, note: 'UTC时间戳（毫秒精度）']
  ts_local datetime(3) [note: '本地时间戳（日本时区）']
  recorded_at timestamp [note: '数据记录时间（兼容字段）']
  quality_flag varchar(20) [not null, default: 'ok', note: '质量标记（ok/missing/anomaly）']
  checksum varchar(64) [note: '完整性校验']
  created_at timestamp [default: `CURRENT_TIMESTAMP`, note: '创建时间']
  updated_at timestamp [default: `CURRENT_TIMESTAMP`, note: '更新时间']
  
  indexes {
    (sensor_id, ts_utc) [name: 'idx_turbidity_sensor_ts']
    (pond_id, ts_utc) [name: 'idx_turbidity_pond_ts']
    (batch_id, ts_utc) [name: 'idx_turbidity_batch_ts']
  }
  note: '浊度读数表 - 存储浊度传感器的测量数据'
}

// 氨氮浓度读数表
Table ammonia_readings {
  id bigint [pk, increment, note: '主键ID']
  sensor_id integer [not null, ref: > sensors.id, note: '传感器设备ID（FK）']
  pond_id integer [not null, ref: > ponds.id, note: '所属养殖池ID（FK）- 快照字段，记录数据产生时的池位']
  batch_id bigint [ref: > batches.batch_id, note: '批次ID（FK）']
  value float [not null, note: '氨氮浓度值']
  metric varchar(32) [default: 'ammonia', note: '指标标识']
  unit varchar(20) [default: 'mg/L', note: '单位（mg/L）']
  description text [note: '描述']
  ts_utc datetime(3) [not null, note: 'UTC时间戳（毫秒精度）']
  ts_local datetime(3) [note: '本地时间戳（日本时区）']
  recorded_at timestamp [note: '数据记录时间（兼容字段）']
  quality_flag varchar(20) [not null, default: 'ok', note: '质量标记（ok/missing/anomaly）']
  checksum varchar(64) [note: '完整性校验']
  created_at timestamp [default: `CURRENT_TIMESTAMP`, note: '创建时间']
  updated_at timestamp [default: `CURRENT_TIMESTAMP`, note: '更新时间']
  
  indexes {
    (sensor_id, ts_utc) [name: 'idx_ammonia_sensor_ts']
    (pond_id, ts_utc) [name: 'idx_ammonia_pond_ts']
    (batch_id, ts_utc) [name: 'idx_ammonia_batch_ts']
  }
  note: '氨氮浓度读数表 - 存储氨氮传感器的测量数据'
}

// 亚硝酸盐浓度读数表
Table nitrite_readings {
  id bigint [pk, increment, note: '主键ID']
  sensor_id integer [not null, ref: > sensors.id, note: '传感器设备ID（FK）']
  pond_id integer [not null, ref: > ponds.id, note: '所属养殖池ID（FK）- 快照字段，记录数据产生时的池位']
  batch_id bigint [ref: > batches.batch_id, note: '批次ID（FK）']
  value float [not null, note: '亚硝酸盐浓度值']
  metric varchar(32) [default: 'nitrite', note: '指标标识']
  unit varchar(20) [default: 'mg/L', note: '单位（mg/L）']
  description text [note: '描述']
  ts_utc datetime(3) [not null, note: 'UTC时间戳（毫秒精度）']
  ts_local datetime(3) [note: '本地时间戳（日本时区）']
  recorded_at timestamp [note: '数据记录时间（兼容字段）']
  quality_flag varchar(20) [not null, default: 'ok', note: '质量标记（ok/missing/anomaly）']
  checksum varchar(64) [note: '完整性校验']
  created_at timestamp [default: `CURRENT_TIMESTAMP`, note: '创建时间']
  updated_at timestamp [default: `CURRENT_TIMESTAMP`, note: '更新时间']
  
  indexes {
    (sensor_id, ts_utc) [name: 'idx_nitrite_sensor_ts']
    (pond_id, ts_utc) [name: 'idx_nitrite_pond_ts']
    (batch_id, ts_utc) [name: 'idx_nitrite_batch_ts']
  }
  note: '亚硝酸盐浓度读数表 - 存储亚硝酸盐传感器的测量数据'
}

// 循环系统读数表
Table circulation_readings {
  id bigint [pk, increment, note: '主键ID']
  sensor_id integer [not null, ref: > sensors.id, note: '传感器设备ID（FK）']
  pond_id integer [not null, ref: > ponds.id, note: '所属养殖池ID（FK）- 快照字段，记录数据产生时的池位']
  batch_id bigint [ref: > batches.batch_id, note: '批次ID（FK）']
  value float [not null, note: '循环系统读数值']
  metric varchar(32) [default: 'circulation', note: '指标标识']
  unit varchar(20) [note: '单位']
  description text [note: '描述']
  ts_utc datetime(3) [not null, note: 'UTC时间戳（毫秒精度）']
  ts_local datetime(3) [note: '本地时间戳（日本时区）']
  recorded_at timestamp [note: '数据记录时间（兼容字段）']
  quality_flag varchar(20) [not null, default: 'ok', note: '质量标记（ok/missing/anomaly）']
  checksum varchar(64) [note: '完整性校验']
  created_at timestamp [default: `CURRENT_TIMESTAMP`, note: '创建时间']
  updated_at timestamp [default: `CURRENT_TIMESTAMP`, note: '更新时间']
  
  indexes {
    (sensor_id, ts_utc) [name: 'idx_circulation_sensor_ts']
    (pond_id, ts_utc) [name: 'idx_circulation_pond_ts']
    (batch_id, ts_utc) [name: 'idx_circulation_batch_ts']
  }
  note: '循环系统读数表 - 存储循环传感器的测量数据'
}

// ============================================================
// 喂食机扩展模块 - Feeder Extension
// ============================================================

Table feeders {
  id integer [pk, increment, note: '主键ID']
  device_id integer [unique, not null, ref: > devices.id, note: '关联设备ID（FK）- 一对一关系，通过此ID关联获取name/pond_id/status等基础信息']
  
  // 云端同步配置
  feed_count integer [default: 1, not null, note: '默认喂食份数（来自云端API的feedCount）']
  timezone integer [default: 9, note: '时区（UTC+，对应云端API的devTimeZone）']
  network_type integer [default: 0, note: '网络类型（0=WiFi, 1=4G，对应云端API的netType）']
  group_id varchar(50) [note: '设备分组ID（对应云端API的groupID）']
  
  // 本地业务配置
  feed_portion_weight decimal(5,1) [default: 17.0, not null, note: '每份饲料重量（克）- 本地配置，用于计算总投喂量']
  capacity_kg decimal(10,2) [note: '饲料容量（千克）']
  feed_type varchar(64) [note: '饲料类型']
  
  created_at timestamp [default: `CURRENT_TIMESTAMP`, note: '创建时间']
  updated_at timestamp [default: `CURRENT_TIMESTAMP`, note: '更新时间']
  
  indexes {
    (device_id) [name: 'idx_feeder_device']
    (group_id) [name: 'idx_feeder_group']
  }
  note: '喂食机扩展表 - 存储喂食机特有信息和云端同步配置。feed_count等字段从云端API同步，feed_portion_weight为本地配置'
}

Table feeder_logs {
  id bigint [pk, increment, note: '主键ID']
  feeder_id integer [not null, ref: > feeders.id, note: '喂食机ID（FK）']
  pond_id integer [not null, ref: > ponds.id, note: '所属养殖池ID（FK）- 快照字段，记录投喂时的池位，用于历史数据一致性和LLM查询优化']
  batch_id bigint [ref: > batches.batch_id, note: '批次ID（FK）']
  ts_utc datetime(3) [not null, note: 'UTC时间戳']
  ts_local datetime(3) [note: '本地时间戳']
  feed_amount_g decimal(12,3) [note: '投喂量（克）']
  run_time_s integer [note: '运行时长（秒）']
  status varchar(20) [not null, default: 'ok', note: '状态（ok/warning/error）']
  leftover_estimate_g decimal(12,3) [note: '剩余饵料估计（克）']
  notes text [note: '备注']
  checksum varchar(64) [note: '完整性校验']
  created_at timestamp [default: `CURRENT_TIMESTAMP`, note: '创建时间']
  updated_at timestamp [default: `CURRENT_TIMESTAMP`, note: '更新时间']
  
  indexes {
    (feeder_id, ts_utc) [name: 'idx_fl_feeder_ts']
    (pond_id, ts_utc) [name: 'idx_fl_pond_ts']
    (batch_id, ts_utc) [name: 'idx_fl_batch_ts']
    (status) [name: 'idx_fl_status']
    (pond_id, status, ts_utc) [name: 'idx_fl_pond_status_ts']
  }
  note: '喂食机运行记录表 - pond_id为快照字段，优化LLM查询和保证历史数据一致性'
}

// ============================================================
// 摄像头扩展模块 - Camera Extension
// ============================================================

Table cameras {
  id integer [pk, increment, note: '主键ID']
  device_id integer [unique, not null, ref: > devices.id, note: '关联设备ID（FK）- 一对一关系，通过此ID关联获取name/pond_id/location等基础信息']
  
  // 当前状态信息（原 camera_status）
  status varchar(50) [not null, default: 'offline', note: '摄像头状态(online/offline)']
  quality varchar(50) [note: '画质(高/中/低)']
  connectivity integer [default: 0, note: '连通性百分比']
  temperature decimal(5,2) [note: '温度']
  last_update bigint [note: '最后更新时间戳(毫秒)']
  last_update_time varchar(50) [note: '最后更新时间字符串']
  
  // 摄像头特有配置
  resolution varchar(50) [note: '分辨率']
  fps integer [default: 0, note: '帧率']
  codec varchar(32) [note: '编解码']
  stream_url varchar(512) [note: '流媒体地址']
  recording boolean [default: false, note: '是否正在录制']
  night_vision boolean [default: false, note: '是否开启夜视功能']
  motion_detection boolean [default: false, note: '是否开启运动检测']
  
  created_at timestamp [default: `CURRENT_TIMESTAMP`, note: '创建时间']
  updated_at timestamp [default: `CURRENT_TIMESTAMP`, note: '更新时间']
  
  indexes {
    (device_id) [name: 'idx_camera_device']
    (status) [name: 'idx_camera_status']
  }
  note: '摄像头扩展表 - 存储摄像头配置和当前状态信息。与devices表1:1关联，与sensors/feeders架构保持一致'
}

Table camera_images {
  id bigint [pk, increment, note: '主键ID']
  camera_id integer [not null, ref: > cameras.id, note: '摄像头ID（FK）']
  pond_id integer [not null, ref: > ponds.id, note: '所属养殖池ID（FK）- 快照字段，记录拍摄时的池位，用于历史数据一致性和LLM查询优化']
  batch_id bigint [ref: > batches.batch_id, note: '批次ID（FK）']
  image_url varchar(500) [not null, note: '图片URL']
  storage_uri varchar(512) [note: '对象存储路径/URI']
  last_update bigint [not null, note: '最后更新时间戳(毫秒)']
  timestamp bigint [not null, note: '图片时间戳(毫秒)']
  ts_utc datetime(3) [not null, note: 'UTC时间戳']
  ts_local datetime(3) [note: '本地时间戳（日本时区）']
  timestamp_str varchar(50) [default: '', note: '图片时间戳字符串']
  width integer [default: 1920, note: '图片宽度（像素）']
  height integer [default: 1080, note: '图片高度（像素）']
  format varchar(20) [default: 'jpg', note: '图片格式(jpg/png等)']
  size integer [default: 0, note: '图片大小(字节)']
  fps integer [default: 0, note: '帧率']
  quality_flag varchar(20) [not null, default: 'ok', note: '质量标记（ok/missing/anomaly）']
  checksum varchar(64) [note: '完整性校验']
  created_at timestamp [default: `CURRENT_TIMESTAMP`, note: '创建时间']
  updated_at timestamp [default: `CURRENT_TIMESTAMP`, note: '更新时间']
  
  indexes {
    (camera_id, timestamp) [name: 'idx_camera_images_camera']
    (pond_id, ts_utc) [name: 'idx_ci_pond_ts']
    (batch_id, ts_utc) [name: 'idx_if_batch_ts']
    (quality_flag, ts_utc) [name: 'idx_ci_quality_ts']
  }
  note: '摄像头图片模型 - pond_id为快照字段，优化LLM查询和保证历史数据一致性'
}

Table camera_health {
  id integer [pk, increment, note: '主键ID']
  camera_id integer [not null, ref: > cameras.id, note: '摄像头ID（FK）']
  pond_id integer [not null, ref: > ponds.id, note: '所属养殖池ID（FK）- 快照字段，记录检查时的池位，用于历史数据一致性和LLM查询优化']
  health_status varchar(50) [not null, note: '健康状态(优秀/良好/一般/需要维护/离线)']
  overall_score decimal(5,2) [not null, note: '总体健康分数(0-100)']
  connectivity_status varchar(50) [not null, note: '连通性检查状态']
  connectivity_score integer [not null, note: '连通性分数']
  connectivity_message varchar(500) [not null, note: '连通性检查消息']
  image_quality_status varchar(50) [not null, note: '图像质量检查状态']
  image_quality_score integer [not null, note: '图像质量分数']
  image_quality_message varchar(500) [not null, note: '图像质量检查消息']
  hardware_status varchar(50) [not null, note: '硬件检查状态']
  hardware_score integer [not null, note: '硬件分数']
  hardware_message varchar(500) [not null, note: '硬件检查消息']
  storage_status varchar(50) [not null, note: '存储检查状态']
  storage_score integer [not null, note: '存储分数']
  storage_message varchar(500) [not null, note: '存储检查消息']
  timestamp bigint [not null, note: '检查时间戳(毫秒)']
  last_check varchar(50) [not null, note: '最后检查时间字符串']
  temperature decimal(5,2) [note: '温度']
  uptime_hours integer [note: '运行时间(小时)']
  created_at timestamp [default: `CURRENT_TIMESTAMP`, note: '创建时间']
  updated_at timestamp [default: `CURRENT_TIMESTAMP`, note: '更新时间']
  
  indexes {
    (camera_id) [name: 'idx_camera_health_camera']
    (pond_id, timestamp) [name: 'idx_ch_pond_ts']
    (health_status) [name: 'idx_camera_health_status']
  }
  note: '摄像头健康检查模型 - pond_id为快照字段，优化LLM查询和保证历史数据一致性'
}

// ============================================================
// 图像分析模块 - Image Analysis
// ============================================================

Table shrimp_stats {
  id bigint [pk, increment, note: '主键ID']
  frame_id bigint [ref: > camera_images.id, note: '图像帧ID（FK -> camera_images）']
  batch_id bigint [ref: > batches.batch_id, note: '批次ID（FK）']
  ts_utc datetime(3) [not null, note: 'UTC时间戳（推理时间）']
  uuid varchar(36) [note: 'UUID']
  pond_id integer [not null, ref: > ponds.id, note: '所属养殖池ID（FK）']
  input_subdir varchar(255) [note: '输入子目录']
  output_dir varchar(512) [note: '输出目录']
  created_at_source_iso varchar(64) [note: '源创建时间ISO']
  created_at_source timestamp [note: '源创建时间']
  conf float [note: '置信度（原有字段）']
  confidence_avg decimal(5,4) [note: '平均置信度']
  iou float [note: 'IOU']
  total_live integer [note: '活虾总数']
  count integer [note: '检测数量']
  total_dead integer [note: '死虾总数']
  size_min_cm float [note: '最小尺寸(cm)']
  size_max_cm float [note: '最大尺寸(cm)']
  size_mean_cm float [note: '平均尺寸(cm)']
  size_median_cm float [note: '中位数尺寸(cm)']
  avg_length_mm decimal(12,3) [note: '平均长度（毫米）']
  avg_height_mm decimal(12,3) [note: '平均高度（毫米）']
  weight_min_g float [note: '最小体重(g)']
  weight_max_g float [note: '最大体重(g)']
  weight_mean_g float [note: '平均体重(g)']
  weight_median_g float [note: '中位数体重(g)']
  est_weight_g_avg decimal(12,3) [note: '平均估算体重（克）']
  feed_present boolean [default: false, note: '是否存在饲料']
  shrimp_shell_present boolean [default: false, note: '是否存在虾皮']
  model_name varchar(128) [note: '模型名称']
  model_version varchar(64) [note: '模型版本']
  notes text [note: '备注']
  source_file varchar(512) [note: '源文件']
  created_at timestamp [default: `CURRENT_TIMESTAMP`, note: '创建时间']
  updated_at timestamp [default: `CURRENT_TIMESTAMP`, note: '更新时间']
  
  indexes {
    (frame_id) [name: 'idx_id_frame']
    (ts_utc) [name: 'idx_id_ts']
    (pond_id) [name: 'idx_shrimp_stats_pond']
    (model_name, model_version) [name: 'idx_id_modelver']
    (batch_id, ts_utc) [name: 'idx_ss_batch_ts']
  }
  note: '图像识别统计结果表'
}

// ============================================================
// 操作日志模块 - Operation Logs
// ============================================================

Table operation_logs {
  id bigint [pk, increment, note: '主键ID']
  operator_id integer [not null, ref: > users.id, note: '操作人ID（FK → users.id）']
  batch_id bigint [ref: > batches.batch_id, note: '批次ID（FK）']
  pond_id integer [ref: > ponds.id, note: '所属养殖池ID（FK）']
  ts_utc datetime(3) [not null, note: 'UTC时间戳']
  ts_local datetime(3) [note: '本地时间戳']
  action_type varchar(64) [not null, note: '操作类型（投料/水质调控/巡检/清洗等）']
  remarks text [note: '备注']
  attachment_uri varchar(512) [note: '附件URI']
  created_at timestamp [default: `CURRENT_TIMESTAMP`, note: '创建时间']
  updated_at timestamp [default: `CURRENT_TIMESTAMP`, note: '更新时间']
  
  indexes {
    (operator_id, ts_utc) [name: 'idx_ol_operator_ts']
    (batch_id, ts_utc) [name: 'idx_ol_batch_ts']
    (pond_id, ts_utc) [name: 'idx_ol_pond_ts']
  }
  note: '人工操作日志表'
}

Table history_records {
  id bigint [pk, increment, note: '主键ID']
  batch_id bigint [ref: > batches.batch_id, note: '批次ID（FK）']
  metric_name varchar(64) [not null, note: '指标名称']
  value varchar(128) [not null, note: '值（文本存储）']
  unit varchar(16) [note: '单位']
  ts_utc datetime(3) [not null, note: 'UTC时间戳']
  ts_local datetime(3) [note: '本地时间戳']
  notes text [note: '备注']
  created_at timestamp [default: `CURRENT_TIMESTAMP`, note: '创建时间']
  updated_at timestamp [default: `CURRENT_TIMESTAMP`, note: '更新时间']
  
  indexes {
    (batch_id, metric_name, ts_utc) [name: 'idx_hr_batch_metric_ts']
  }
  note: '往期养殖记录表（结构化）'
}

// ============================================================
// AI决策模块 - AI Decision
// ============================================================

Table ai_decisions {
  id integer [pk, increment, note: '主键ID']
  decision_id varchar(64) [unique, not null, note: '决策唯一标识']
  type varchar(50) [not null, note: '消息类型：analysis-分析, warning-警告, action-操作, optimization-优化']
  message text [not null, note: '决策消息内容']
  action text [note: '建议操作内容']
  source varchar(100) [note: '数据源类型(sensor/device/system/manual)']
  source_id varchar(100) [note: '数据源具体ID']
  priority integer [default: 0, note: '优先级(0-10，数字越大优先级越高)']
  confidence decimal(5,2) [default: 0, note: 'AI决策置信度(0-100)']
  status varchar(50) [not null, default: 'active', note: '状态：active-活跃, processed-已处理, expired-已过期']
  expires_at timestamp [note: '过期时间，过期后消息将不再显示']
  created_at timestamp [default: `CURRENT_TIMESTAMP`, note: '创建时间']
  updated_at timestamp [default: `CURRENT_TIMESTAMP`, note: '更新时间']
  
  indexes {
    (type) [name: 'idx_decision_type']
    (status) [name: 'idx_decision_status']
    (priority) [name: 'idx_decision_priority']
    (source, source_id) [name: 'idx_decision_source']
  }
  note: 'AI决策消息模型 - 存储AI系统生成的各类决策消息'
}

Table message_types {
  id integer [pk, increment, note: '主键ID']
  type varchar(50) [unique, not null, note: '消息类型标识']
  icon varchar(10) [not null, note: '消息图标(emoji)']
  color varchar(20) [not null, note: '消息颜色(hex或颜色名)']
  description varchar(255) [note: '消息类型描述']
  is_active boolean [default: true, note: '是否启用该消息类型']
  created_at timestamp [default: `CURRENT_TIMESTAMP`, note: '创建时间']
  updated_at timestamp [default: `CURRENT_TIMESTAMP`, note: '更新时间']
  
  note: '消息类型配置模型 - 定义不同类型消息的显示样式和属性'
}

Table decision_rules {
  id integer [pk, increment, note: '主键ID']
  rule_id varchar(64) [unique, not null, note: '规则唯一标识']
  name varchar(255) [not null, note: '规则名称']
  condition_type varchar(50) [not null, note: '条件类型(sensor/device/time/manual)']
  condition_config text [note: '条件配置(JSON格式)']
  message_template text [not null, note: '消息模板，支持变量替换']
  action_template text [note: '操作模板，支持变量替换']
  decision_type varchar(50) [not null, note: '决策类型(analysis/warning/action/optimization)']
  priority integer [default: 0, note: '规则优先级(0-10)']
  is_active boolean [default: true, note: '是否启用该规则']
  created_at timestamp [default: `CURRENT_TIMESTAMP`, note: '创建时间']
  updated_at timestamp [default: `CURRENT_TIMESTAMP`, note: '更新时间']
  
  indexes {
    (condition_type) [name: 'idx_rule_condition_type']
    (decision_type) [name: 'idx_rule_decision_type']
    (is_active) [name: 'idx_rule_is_active']
  }
  note: 'AI决策规则模型 - 定义触发AI决策的条件和规则'
}

// ============================================================
// 用户系统模块 - User System
// ============================================================

Table users {
  id integer [pk, increment, note: '主键ID']
  user_id varchar(128) [unique, not null, note: '用户唯一标识ID']
  username varchar(128) [unique, not null, note: '用户名（唯一）']
  password_hash varchar(128) [not null, note: '密码哈希值']
  role varchar(128) [not null, note: '角色（admin=管理员/employee=员工/user=普通用户）']
  email varchar(255) [unique, note: '邮箱（唯一）']
  phone varchar(32) [unique, note: '电话（唯一）']
  status varchar(50) [not null, default: 'active', note: '状态（active/inactive/suspended）']
  created_at timestamp [default: `CURRENT_TIMESTAMP`, note: '创建时间']
  updated_at timestamp [default: `CURRENT_TIMESTAMP`, note: '更新时间']
  
  indexes {
    (user_id) [name: 'idx_user_id']
    (username) [name: 'idx_username']
    (email) [name: 'idx_email']
    (phone) [name: 'idx_phone']
    (role) [name: 'idx_user_role']
  }
  note: '用户表 - 通过role字段区分管理员/员工/普通用户'
}

Table sessions {
  id integer [pk, increment, note: '主键ID']
  session_id varchar(128) [unique, not null, note: '会话唯一标识ID']
  user_id integer [not null, ref: > users.id, note: '用户ID（FK → users.id）']
  session_name varchar(128) [default: 'new chat', note: '会话名称']
  config text [note: '会话配置']
  summary varchar(2048) [note: '会话摘要']
  status varchar(50) [not null, default: 'active', note: '状态（active/inactive）']
  created_at timestamp [default: `CURRENT_TIMESTAMP`, note: '创建时间']
  updated_at timestamp [default: `CURRENT_TIMESTAMP`, note: '更新时间']
  
  indexes {
    (session_id) [name: 'idx_session_id']
    (user_id) [name: 'idx_session_user']
  }
  note: '会话表'
}

Table chat_histories {
  id integer [pk, increment, note: '主键ID']
  session_id integer [not null, ref: > sessions.id, note: '会话ID（FK → sessions.id）']
  message_id varchar(128) [note: '消息唯一ID']
  role varchar(32) [note: '角色（user/assistant/system）']
  content text [note: '消息内容']
  type varchar(50) [note: '消息类型']
  tool_calls text [note: '工具调用（JSON）']
  meta_data text [note: '元数据（JSON）']
  status varchar(50) [not null, default: 'active', note: '状态']
  timestamp timestamp [default: `CURRENT_TIMESTAMP`, note: '时间戳']
  updated_at timestamp [default: `CURRENT_TIMESTAMP`, note: '更新时间']
  
  indexes {
    (session_id) [name: 'idx_chat_session']
    (message_id) [name: 'idx_chat_message']
  }
  note: '聊天历史表'
}

// ============================================================
// 任务系统模块 - Task System
// ============================================================

Table agent_tasks {
  id bigint [pk, increment, note: '主键ID']
  task_id varchar(255) [unique, not null, note: '任务唯一标识']
  session_id integer [ref: > sessions.id, note: '会话ID（FK → sessions.id）']
  parent_task_id varchar(255) [note: '父任务ID']
  goal text [not null, note: '任务目标']
  input_params json [note: '输入参数']
  result json [note: '执行结果']
  error_message text [note: '错误消息']
  logs text [note: '日志']
  tool_calls json [note: '工具调用']
  token_usage integer [note: 'Token使用量']
  status varchar(50) [not null, default: 'pending', note: '状态（pending/processing/completed/failed）']
  priority integer [default: 0, note: '优先级']
  completed_at timestamp [note: '完成时间']
  created_at timestamp [default: `CURRENT_TIMESTAMP`, note: '创建时间']
  updated_at timestamp [default: `CURRENT_TIMESTAMP`, note: '更新时间']
  
  indexes {
    (task_id) [name: 'idx_agent_task_id']
    (session_id) [name: 'idx_agent_task_session']
    (status) [name: 'idx_agent_task_status']
  }
  note: '大模型Agent运行的任务表'
}

Table tasks {
  id integer [pk, increment, note: '主键ID']
  task_id varchar(64) [unique, not null, note: '任务唯一标识']
  task_name varchar(255) [not null, note: '任务名称']
  description text [note: '任务描述']
  priority varchar(20) [not null, default: '中', note: '优先级（高/中/低）']
  assignee_id integer [not null, ref: > users.id, note: '负责人ID（FK → users.id，角色应为employee或admin）']
  pond_id integer [ref: > ponds.id, note: '关联养殖池ID（FK）']
  due_date timestamp [note: '截止时间']
  task_type varchar(64) [note: '任务类型（maintenance/feeding/inspection/cleaning/emergency）']
  status varchar(50) [not null, default: 'pending', note: '状态（pending/assigned/in_progress/completed/cancelled）']
  started_at timestamp [note: '开始时间']
  completed_at timestamp [note: '完成时间']
  related_device_id integer [ref: > devices.id, note: '关联设备ID（可选）']
  notes text [note: '备注/进度记录']
  created_at timestamp [default: `CURRENT_TIMESTAMP`, note: '创建时间']
  updated_at timestamp [default: `CURRENT_TIMESTAMP`, note: '更新时间']
  
  indexes {
    (task_id) [name: 'idx_task_id']
    (assignee_id, status) [name: 'idx_task_assignee_status']
    (pond_id, status) [name: 'idx_task_pond_status']
    (priority, due_date) [name: 'idx_task_priority_due']
    (status, due_date) [name: 'idx_task_status_due']
  }
  note: '任务管理表 - 用于分配任务给用户（员工角色），通过users表的phone/email进行通知'
}

Table message_queues {
  id integer [pk, increment, note: '主键ID']
  message_id varchar(128) [unique, not null, note: '消息唯一标识']
  content text [not null, note: '消息内容']
  message_metadata text [note: '消息元数据(JSON格式)']
  message_type varchar(50) [not null, default: 'general', note: '消息类型(sensor_data/user_input/system_alert/general)']
  priority integer [not null, default: 5, note: '消息优先级(0-10，数字越大优先级越高)']
  status varchar(50) [not null, default: 'pending', note: '消息状态：pending-待处理, processing-处理中, completed-已完成, failed-处理失败, expired-已过期']
  retry_count integer [not null, default: 0, note: '重试次数']
  max_retries integer [not null, default: 3, note: '最大重试次数']
  error_message text [note: '处理失败时的错误信息']
  consumed_at timestamp [note: '开始处理时间']
  completed_at timestamp [note: '处理完成时间']
  expires_at timestamp [note: '消息过期时间']
  created_at timestamp [default: `CURRENT_TIMESTAMP`, note: '消息接收时间']
  updated_at timestamp [default: `CURRENT_TIMESTAMP`, note: '更新时间']
  
  indexes {
    (status) [name: 'idx_mq_status']
    (priority) [name: 'idx_mq_priority']
    (message_type) [name: 'idx_mq_message_type']
  }
  note: '消息队列模型 - 存储待处理的消息，用于多智能体协作系统'
}

// ============================================================
// 知识库模块 - Knowledge Base
// ============================================================

Table knowledge_bases {
  id integer [pk, increment, note: '自增主键ID']
  knowledge_base_id varchar(36) [unique, not null, note: '知识库唯一标识ID']
  knowledge_base_name varchar(255) [not null, note: '知识库名称']
  description varchar(1024) [note: '知识库描述']
  created_at timestamp [default: `CURRENT_TIMESTAMP`, note: '创建时间']
  updated_at timestamp [default: `CURRENT_TIMESTAMP`, note: '更新时间']
  
  indexes {
    (knowledge_base_id) [name: 'idx_kb_id']
    (knowledge_base_name) [name: 'idx_kb_name']
  }
  note: '知识库表 - 存储知识库的基本信息'
}

Table knowledge_documents {
  id integer [pk, increment, note: '自增主键ID']
  knowledge_base_id integer [not null, ref: > knowledge_bases.id, note: '所属知识库ID（FK → knowledge_bases.id）']
  document_name varchar(512) [not null, note: '文档名称']
  document_path varchar(1024) [note: '文档存储路径']
  document_type varchar(50) [note: '文档类型：txt, pdf, docx 等']
  file_size integer [note: '文件大小（字节）']
  created_at timestamp [default: `CURRENT_TIMESTAMP`, note: '创建时间']
  updated_at timestamp [default: `CURRENT_TIMESTAMP`, note: '更新时间']
  
  indexes {
    (knowledge_base_id) [name: 'idx_doc_kb_id']
    (document_name) [name: 'idx_doc_name']
  }
  note: '知识库文档表 - 存储知识库中的文档信息'
}

Table manual_docs {
  id bigint [pk, increment, note: '主键ID']
  doc_uri varchar(512) [not null, note: '文档URI']
  version varchar(64) [note: '版本']
  source varchar(64) [note: '来源']
  notes text [note: '备注']
  created_at timestamp [default: `CURRENT_TIMESTAMP`, note: '创建时间']
  updated_at timestamp [default: `CURRENT_TIMESTAMP`, note: '更新时间']
  
  indexes {
    (version) [name: 'idx_md_version']
  }
  note: '养殖手册/文档索引表'
}

// ============================================================
// 配置模块 - Configuration
// ============================================================

Table tools {
  id integer [pk, increment, note: '主键ID']
  tool_id varchar(36) [unique, not null, note: '工具唯一标识ID']
  name varchar(255) [unique, not null, note: '工具名称']
  description varchar(1024) [not null, note: '工具描述']
  type varchar(50) [not null, note: '工具类型']
  mode varchar(50) [not null, note: '工具模式']
  location text [note: '工具的位置信息，例如模块名和函数名']
  schema_def text [note: '工具的参数定义']
  ownership varchar(50) [not null, default: 'default', note: '所有权']
  
  indexes {
    (tool_id) [name: 'idx_tool_id']
    (name) [name: 'idx_tool_name']
  }
  note: '工具表'
}

Table prompts {
  id integer [pk, increment, note: '主键ID']
  agent_name varchar(255) [not null, note: '智能体名称']
  template_key varchar(255) [note: '模板键，用于区分同一智能体的不同模板']
  description text [note: '模板描述']
  version varchar(50) [note: '模板版本']
  template text [not null, note: '提示模板内容']
  created_at timestamp [default: `CURRENT_TIMESTAMP`, note: '创建时间']
  updated_at timestamp [default: `CURRENT_TIMESTAMP`, note: '更新时间']
  
  indexes {
    (agent_name) [name: 'idx_prompt_agent']
    (agent_name, template_key) [unique, name: 'uq_agent_name_template_key']
  }
  note: 'Prompt模型 - 用于存储和管理所有AI智能体的提示（Prompt）模板'
}

Table models {
  id integer [pk, increment, note: '自增主键ID']
  model_id varchar(36) [unique, not null, note: '模型唯一标识ID']
  model_name varchar(255) [not null, note: '模型名称，如 gpt-4o, gpt-4o-mini']
  description varchar(1024) [not null, note: '模型描述']
  status varchar(50) [not null, default: 'activate', note: '模型状态：activate, deactivate']
  perm varchar(50) [not null, default: 'public', note: '权限类型：public, private']
  created_at timestamp [default: `CURRENT_TIMESTAMP`, note: '创建时间']
  updated_at timestamp [default: `CURRENT_TIMESTAMP`, note: '更新时间']
  
  indexes {
    (model_id) [name: 'idx_model_id']
    (status) [name: 'idx_model_status']
  }
  note: 'AI模型表 - 存储可用的AI模型信息'
}

Table topic_memories {
  id integer [pk, increment, note: '自增主键ID']
  topic_id varchar(128) [unique, not null, note: '主题唯一标识ID']
  topic_name varchar(255) [not null, note: '归类的主题名称']
  topic_content text [note: '总结的主题内容描述']
  related_tags text [note: '该主题的关键标签，多个标签用逗号分隔']
  session_id integer [not null, ref: > sessions.id, note: '创建该主题的会话ID（FK → sessions.id）']
  status varchar(50) [not null, default: 'active', note: '主题状态：active-活跃，inactive-非活跃，deleted-已删除']
  created_at timestamp [default: `CURRENT_TIMESTAMP`, note: '主题最初创建时间']
  updated_at timestamp [default: `CURRENT_TIMESTAMP`, note: '主题最新更新时间']
  
  indexes {
    (topic_id) [name: 'idx_topic_id']
    (session_id) [name: 'idx_topic_session']
  }
  note: '话题记忆表 - 用于存储海马体式的分类记忆用户聊天话题主题'
}

// ============================================================
// 说明 - Notes
// ============================================================
// 所有外键关系已在表字段定义中使用 [ref: > table.field] 语法定义
// 避免在此处重复定义造成 "References with same endpoints exist" 错误

