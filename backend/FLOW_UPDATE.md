# 流程调整说明

## 调整后的流程

```
用户输入 → 查询重写 → 意图识别 → 路由决策 → 专家咨询 (SSE流式) → 生成回答
```

## 关键变化

### 1. 查询重写的作用
- **之前**: 只是将问题重写为更完整的问题
- **现在**: 将问题拆分成更具体的问题，便于专家进行数据查询和分析

### 2. 专家咨询的位置
- **之前**: 在查询重写之后立即调用
- **现在**: 在路由决策之后，根据决策结果决定是否调用

### 3. 数据查询的职责
- **之前**: 系统负责数据查询，专家只是提供建议
- **现在**: 专家负责数据查询、聚合和结论输出，系统不负责具体的数据查询（仅作为兜底方案）

### 4. 生成回答的方式
- **之前**: 结合专家建议和数据查询结果生成回答
- **现在**: 基于专家的完整回答（包含数据查询和聚合结果）生成最终回答

## 详细流程说明

### 步骤 1: 用户输入
用户提交问题，例如："那pH值呢？"

### 步骤 2: 查询重写
将问题拆分成更具体的问题：
- 原始问题: "那pH值呢？"
- 重写后: "查询当前养殖池的pH值数据，包括最新值和历史趋势"

### 步骤 3: 意图识别
识别用户意图，例如："数据查询"

### 步骤 4: 路由决策
判断是否需要调用专家：
- 如果需要数据查询和分析 → `needs_expert: true`, `needs_data: true`
- 如果只是简单聊天 → `needs_expert: false`, `needs_data: false`

### 步骤 5: 专家咨询（如果需要）
如果路由决策判断需要调用专家：
1. 调用专家API（SSE流式）
2. 专家进行数据查询
3. 专家进行数据聚合
4. 专家生成结论和建议
5. 返回完整的专家回答

### 步骤 6: 生成回答
基于专家的回答生成最终回答：
- 如果专家咨询成功：使用专家的完整回答作为输入
- 如果专家咨询失败：使用兜底的数据查询结果（如果有）

## 代码变更

### 1. RoutingAgent 更新
- 添加 `needs_expert` 字段
- 更新决策逻辑，判断是否需要调用专家

### 2. Main.py 流程调整
- 移除查询重写后的立即专家咨询
- 在路由决策后根据 `needs_expert` 或 `needs_data` 决定是否调用专家
- 专家咨询成功后，使用专家回答生成最终回答

### 3. 数据查询逻辑
- 仅在专家咨询失败时作为兜底方案
- 使用简单的关键词匹配

## 优势

1. **职责清晰**: 专家负责数据查询和聚合，系统负责流程编排
2. **更灵活**: 根据路由决策决定是否调用专家
3. **更高效**: 避免不必要的专家调用
4. **更准确**: 专家完成完整的数据查询和分析流程

## 配置

专家服务配置保持不变：
- `EXPERT_API_BASE_URL`: 专家API地址（默认: http://localhost:5003）
- `ENABLE_EXPERT_CONSULTATION`: 是否启用专家咨询（默认: true）

## 测试

测试流程：
1. 发送需要数据查询的问题（如"查询pH值"）
2. 检查控制台输出，确认流程顺序正确
3. 验证专家咨询在路由决策之后调用
4. 验证最终回答基于专家回答生成

