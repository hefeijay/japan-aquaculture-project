# 服务端数据接收接口完善总结

## 概述

根据客户端 `ai_japan` 项目的数据发送格式，完善了服务端 `japan_server` 的数据接收接口，确保能够正确接收和保存客户端发送的所有数据。

## 客户端数据格式分析

### 1. 传感器数据 (`send_sensor_data`)

**发送格式：**
```json
{
    "sensor_id": 1,
    "batch_id": 2,
    "pool_id": "4",
    "value": 25.5,
    "metric": "do",
    "unit": "mg/L",
    "timestamp": 1234567890000,  // Unix时间戳（毫秒），可选
    "type_name": "溶解氧传感器",  // 可选
    "description": "4号池 - do"  // 可选
}
```

**服务端接口：** `POST /api/data/sensors`

**状态：** ✅ 已完善，完全匹配客户端格式

### 2. 喂食机数据 (`send_feeder_data`)

**发送格式：**
```json
{
    "feeder_id": "AI",
    "batch_id": 2,
    "pool_id": "4",
    "feed_amount_g": 68.0,  // 可选
    "run_time_s": 120,  // 可选
    "status": "ok",
    "leftover_estimate_g": 50.0,  // 可选
    "notes": "定时投喂 4 份",  // 可选
    "timestamp": 1234567890000  // Unix时间戳（毫秒），可选
}
```

**服务端接口：** `POST /api/data/feeders`

**状态：** ✅ 已完善，完全匹配客户端格式

**特殊处理：**
- `feeder_id` 可能是字符串（如 "AI"），服务端会尝试转换为整数，如果无法转换则使用hash值

### 3. 操作日志数据 (`send_operation_data`)

**发送格式：**
```json
{
    "operator_id": "user001",
    "batch_id": 2,
    "pool_id": "4",
    "action_type": "投料",
    "remarks": "正常投喂操作",  // 可选
    "attachment_uri": "s3://bucket/file.pdf",  // 可选
    "timestamp": 1234567890000  // Unix时间戳（毫秒），可选
}
```

**服务端接口：** `POST /api/data/operations`

**状态：** ✅ 已完善，完全匹配客户端格式

### 4. 摄像头图像数据 (`send_camera_image`)

**发送格式：** `multipart/form-data`

**文件字段：**
- `file`: 图像文件（必需）

**数据字段：**
```json
{
    "camera_id": "1",
    "batch_id": "2",
    "pool_id": "4",
    "timestamp": "1234567890000",  // Unix时间戳（毫秒），可选
    "width_px": "1920",  // 可选
    "height_px": "1080",  // 可选
    "format": "jpg"  // 可选
}
```

**服务端接口：** `POST /api/data/cameras`

**状态：** ✅ 新创建，完全匹配客户端格式

**功能：**
- 接收multipart/form-data格式的文件上传
- 自动处理时间戳转换
- 自动读取图像尺寸（如果未提供）
- 保存文件到本地目录（实际应该使用对象存储）
- 生成校验和
- 保存完整元数据到数据库

## 接口实现细节

### 1. 传感器数据接收接口

**文件：** `routes/data_collection_routes.py`

**功能：**
- ✅ 接收JSON格式的传感器数据
- ✅ 验证必填字段（sensor_id, value）
- ✅ 时间标准化（UTC和本地时间）
- ✅ 异常值检测
- ✅ 生成校验和
- ✅ 保存到 `sensor_readings` 表

**数据字段映射：**
- `sensor_id` → `sensor_id`
- `batch_id` → `batch_id`
- `pool_id` → `pool_id`
- `value` → `value`
- `metric` → `metric`
- `unit` → `unit`
- `timestamp` → `ts_utc`, `ts_local`, `recorded_at`
- `type_name` → `type_name`
- `description` → `description`
- 自动生成 `quality_flag` 和 `checksum`

### 2. 喂食机数据接收接口

**文件：** `routes/data_collection_routes.py`

**功能：**
- ✅ 接收JSON格式的喂食机数据
- ✅ 验证必填字段（feeder_id）
- ✅ 处理字符串类型的feeder_id（转换为整数或hash值）
- ✅ 时间标准化
- ✅ 生成校验和
- ✅ 保存到 `feeders_logs` 表

**数据字段映射：**
- `feeder_id` → `feeder_id`（自动转换）
- `batch_id` → `batch_id`
- `pool_id` → `pool_id`
- `feed_amount_g` → `feed_amount_g`
- `run_time_s` → `run_time_s`
- `status` → `status`
- `leftover_estimate_g` → `leftover_estimate_g`
- `notes` → `notes`
- `timestamp` → `ts_utc`, `ts_local`
- 自动生成 `checksum`

### 3. 操作日志接收接口

**文件：** `routes/data_collection_routes.py`

**功能：**
- ✅ 接收JSON格式的操作日志数据
- ✅ 验证必填字段（operator_id, action_type）
- ✅ 时间标准化
- ✅ 保存到 `operations_logs` 表

**数据字段映射：**
- `operator_id` → `operator_id`
- `batch_id` → `batch_id`
- `pool_id` → `pool_id`
- `action_type` → `action_type`
- `remarks` → `remarks`
- `attachment_uri` → `attachment_uri`
- `timestamp` → `ts_utc`, `ts_local`

### 4. 摄像头图像接收接口

**文件：** `routes/data_collection_routes.py`

**功能：**
- ✅ 接收multipart/form-data格式的文件上传
- ✅ 验证必填字段（file, camera_id）
- ✅ 处理图像文件保存
- ✅ 自动读取图像尺寸（如果未提供）
- ✅ 时间标准化
- ✅ 生成校验和
- ✅ 保存到 `camera_images` 表

**数据字段映射：**
- `camera_id` → `camera_id`
- `batch_id` → `batch_id`
- `pool_id` → `pool_id`
- `timestamp` → `ts_utc`, `ts_local`, `timestamp`, `last_update`
- `width_px` → `width_px`, `width`
- `height_px` → `height_px`, `height`
- `format` → `format`
- 自动生成 `name`, `location`, `status`, `image_url`, `storage_uri`, `quality_flag`, `checksum`

## 数据清洗服务

**文件：** `services/data_cleaning_service.py`

**功能：**
- ✅ `standardize_time()`: 时间标准化，支持多种时间格式
- ✅ `normalize_unit()`: 单位统一转换
- ✅ `detect_anomaly()`: 异常值检测
- ✅ `generate_checksum()`: 生成完整性校验和
- ✅ `determine_quality_flag()`: 确定质量标记

## 数据库模型

### 1. SensorReading

**文件：** `db_models/sensor_reading.py`

**字段：**
- ✅ `sensor_id`, `batch_id`, `pool_id`
- ✅ `value`, `metric`, `unit`
- ✅ `ts_utc`, `ts_local`, `recorded_at`
- ✅ `type_name`, `description`
- ✅ `quality_flag`, `checksum`
- ✅ `created_at`, `updated_at`

### 2. FeederLog

**文件：** `db_models/feeder_log.py`

**字段：**
- ✅ `feeder_id`, `batch_id`, `pool_id`
- ✅ `feed_amount_g`, `run_time_s`, `status`
- ✅ `leftover_estimate_g`, `notes`
- ✅ `ts_utc`, `ts_local`
- ✅ `checksum`
- ✅ `created_at`, `updated_at`

### 3. OperationLog

**文件：** `db_models/operation_log.py`

**字段：**
- ✅ `operator_id`, `batch_id`, `pool_id`
- ✅ `action_type`, `remarks`, `attachment_uri`
- ✅ `ts_utc`, `ts_local`
- ✅ `created_at`, `updated_at`

### 4. CameraImage

**文件：** `db_models/camera.py`

**字段：**
- ✅ `camera_id`, `batch_id`, `pool_id`
- ✅ `name`, `location`, `status`
- ✅ `image_url`, `storage_uri`
- ✅ `ts_utc`, `ts_local`, `timestamp`, `last_update`
- ✅ `width_px`, `height_px`, `width`, `height`
- ✅ `format`, `codec`, `size`, `fps`
- ✅ `quality_flag`, `checksum`
- ✅ `created_at`, `updated_at`

## 接口测试建议

### 1. 传感器数据接口测试

```bash
curl -X POST http://localhost:5000/api/data/sensors \
  -H "Content-Type: application/json" \
  -d '{
    "sensor_id": 1,
    "batch_id": 2,
    "pool_id": "4",
    "value": 25.5,
    "metric": "do",
    "unit": "mg/L",
    "type_name": "溶解氧传感器",
    "description": "4号池 - do"
  }'
```

### 2. 喂食机数据接口测试

```bash
curl -X POST http://localhost:5000/api/data/feeders \
  -H "Content-Type: application/json" \
  -d '{
    "feeder_id": "AI",
    "batch_id": 2,
    "pool_id": "4",
    "feed_amount_g": 68.0,
    "run_time_s": 120,
    "status": "ok",
    "notes": "定时投喂 4 份"
  }'
```

### 3. 操作日志接口测试

```bash
curl -X POST http://localhost:5000/api/data/operations \
  -H "Content-Type: application/json" \
  -d '{
    "operator_id": "user001",
    "batch_id": 2,
    "pool_id": "4",
    "action_type": "投料",
    "remarks": "正常投喂操作"
  }'
```

### 4. 摄像头图像接口测试

```bash
curl -X POST http://localhost:5000/api/data/cameras \
  -F "file=@/path/to/image.jpg" \
  -F "camera_id=1" \
  -F "batch_id=2" \
  -F "pool_id=4" \
  -F "width_px=1920" \
  -F "height_px=1080" \
  -F "format=jpg"
```

## 待优化项

### 1. 文件存储

**当前实现：** 文件保存到本地目录 `uploads/cameras/`

**建议优化：**
- 使用对象存储（如阿里云OSS、AWS S3）
- 实现文件上传到对象存储
- 返回对象存储URL

### 2. 错误处理

**当前实现：** 基本的错误处理和日志记录

**建议优化：**
- 添加更详细的错误信息
- 实现错误重试机制
- 添加数据验证规则

### 3. 性能优化

**建议优化：**
- 实现批量数据接收接口
- 添加数据缓存机制
- 优化数据库查询性能

## 总结

✅ **所有接口已完善，能够正确接收和保存客户端发送的数据**

- ✅ 传感器数据接口：完全匹配客户端格式
- ✅ 喂食机数据接口：完全匹配客户端格式，支持字符串ID转换
- ✅ 操作日志接口：完全匹配客户端格式
- ✅ 摄像头图像接口：新创建，完全匹配客户端格式

所有接口都已实现：
- 数据验证
- 时间标准化
- 异常值检测（传感器数据）
- 校验和生成
- 数据库保存

项目已准备好接收客户端数据。

