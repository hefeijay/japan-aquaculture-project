# 两个服务端项目对比分析

## 项目概述

### 1. external_data_server
**路径：** `/usr/henry/cognitive-center/external_data_server`

**定位：** 文件存储服务 / 数据中转服务

**主要功能：**
- 接收客户端发送的数据文件
- 将数据保存到文件系统
- 提供文件查询和下载接口

### 2. japan_server
**路径：** `/srv/japan_server`

**定位：** 数据接收服务端 / 数据库存储服务

**主要功能：**
- 接收客户端发送的结构化数据
- 数据清洗和验证
- 直接保存到数据库（MySQL）

## 详细对比

### 1. 数据接收接口

#### external_data_server

**接口1：** `POST /api/transfer_data`（文件存储）

**数据格式：**
```json
{
    "type": "操作日志" | "传感器数据" | "采集图像",
    "content": {
        // 数据内容（JSON对象、数组或Base64编码的图像）
    }
}
```

**特点：**
- 通用接口，通过 `type` 字段区分数据类型
- 数据保存到文件系统（`shared_data/` 目录）
- 支持三种数据类型：操作日志、传感器数据、采集图像
- 图像数据使用Base64编码传输

**存储方式：**
- 操作日志 → `shared_data/operation_logs/`
- 传感器数据 → `shared_data/sensor_data/`
- 采集图像 → `shared_data/collected_images/`

**接口2：** `POST /api/updata_sensor_data`（数据库存储）

**数据格式（旧格式）：**
```json
{
    "时间": "2025-10-09 14:29:45",
    "溶解氧饱和度": 6.81,
    "液位(mm)": 1074,
    "PH": 7.5,
    "PH温度(°C)": 25.0,
    "浊度(NTU)": 10.5,
    "浊度温度(°C)": 25.0
}
```

**特点：**
- 专用传感器数据接口
- 使用中文字段名（旧格式）
- 数据保存到数据库（`sensor_readings` 表）
- 字段映射：中文字段 → sensor_id
- **与客户端新格式不匹配**

**存储方式：**
- 传感器数据 → `sensor_readings` 表（数据库）

#### japan_server

**接口：**
- `POST /api/data/sensors` - 传感器数据
- `POST /api/data/feeders` - 喂食机数据
- `POST /api/data/operations` - 操作日志
- `POST /api/data/cameras` - 摄像头图像

**数据格式（传感器示例）：**
```json
{
    "sensor_id": 1,
    "batch_id": 2,
    "pool_id": "4",
    "value": 25.5,
    "metric": "do",
    "unit": "mg/L",
    "timestamp": 1234567890000,
    "type_name": "溶解氧传感器",
    "description": "4号池 - do"
}
```

**特点：**
- 专用接口，每种数据类型有独立的端点
- 数据直接保存到数据库（MySQL）
- 包含完整的元数据（batch_id, pool_id, ts_utc, ts_local等）
- 支持数据清洗（时间标准化、异常检测、校验和生成）
- 图像数据使用multipart/form-data上传

**存储方式：**
- 传感器数据 → `sensor_readings` 表
- 喂食机数据 → `feeders_logs` 表
- 操作日志 → `operations_logs` 表
- 摄像头图像 → `camera_images` 表

### 2. 数据处理能力

#### external_data_server

**数据处理：**
- ✅ 接收数据
- ✅ 文件保存
- ✅ 文件查询
- ❌ 数据清洗
- ❌ 数据验证
- ❌ 异常检测
- ❌ 数据库存储

**适用场景：**
- 数据中转
- 文件存储
- 数据备份
- 临时数据存储

#### japan_server

**数据处理：**
- ✅ 接收数据
- ✅ 数据验证
- ✅ 数据清洗（时间标准化、单位转换）
- ✅ 异常检测
- ✅ 校验和生成
- ✅ 数据库存储
- ✅ ORM模型管理

**适用场景：**
- 生产数据接收
- 实时数据存储
- 数据分析和查询
- 系统集成

### 3. 数据库集成

#### external_data_server

**数据库：**
- 有数据库配置（SQLAlchemy）
- 主要用于其他功能（用户、会话、任务等）
- **不用于数据接收存储**

**数据存储：**
- 文件系统存储
- 无结构化数据管理

#### japan_server

**数据库：**
- 完整的数据库集成（MySQL）
- 使用ORM模型（SQLAlchemy）
- **直接存储接收的数据**

**数据模型：**
- `SensorReading` - 传感器读数
- `FeederLog` - 喂食机记录
- `OperationLog` - 操作日志
- `CameraImage` - 摄像头图像
- `Batch` - 批次信息

### 4. 数据清洗服务

#### external_data_server

**数据清洗：**
- ❌ 无数据清洗服务
- ❌ 无时间标准化
- ❌ 无异常检测
- ❌ 无校验和生成

#### japan_server

**数据清洗服务：** `services/data_cleaning_service.py`

**功能：**
- ✅ `standardize_time()` - 时间标准化（UTC和本地时间）
- ✅ `normalize_unit()` - 单位统一转换
- ✅ `detect_anomaly()` - 异常值检测
- ✅ `generate_checksum()` - 生成完整性校验和
- ✅ `determine_quality_flag()` - 确定质量标记

### 5. 接口设计

#### external_data_server

**设计特点：**
- 通用接口设计
- 通过 `type` 字段区分数据类型
- 简单直接，适合文件存储

**接口列表：**
- `POST /api/transfer_data` - 接收数据
- `POST /api/get_files` - 获取文件
- `POST /api/updata_file` - 上传文件

#### japan_server

**设计特点：**
- RESTful API设计
- 专用接口，每种数据类型独立端点
- 符合REST规范

**接口列表：**
- `POST /api/data/sensors` - 传感器数据
- `POST /api/data/feeders` - 喂食机数据
- `POST /api/data/operations` - 操作日志
- `POST /api/data/cameras` - 摄像头图像

### 6. 与客户端匹配度

#### external_data_server

**匹配度：** ❌ 不匹配

**原因：**
1. **`/api/transfer_data` 接口：**
   - 客户端发送的是结构化JSON数据，包含完整元数据（batch_id, pool_id, metric等）
   - external_data_server 需要 `type` 和 `content` 格式
   - 数据格式不匹配

2. **`/api/updata_sensor_data` 接口：**
   - 使用旧的数据格式（中文字段名：`溶解氧饱和度`、`液位(mm)`等）
   - 客户端发送的是新格式（标准化字段：`metric`、`value`、`unit`等）
   - 缺少元数据支持（batch_id, pool_id, ts_utc等）
   - 数据格式不匹配

#### japan_server

**匹配度：** ✅ 完全匹配

**原因：**
- 接口设计完全匹配客户端 `api_client` 的发送格式
- 支持所有客户端发送的字段
- 数据格式完全一致

## 结论

### 哪个是数据接收服务端？

**答案：`japan_server` 是真正的数据接收服务端**

### 理由：

1. **数据格式匹配**
   - `japan_server` 的接口格式完全匹配客户端 `ai_japan` 的发送格式
   - `external_data_server` 的数据格式与客户端不匹配

2. **数据库存储**
   - `japan_server` 直接将数据保存到数据库
   - `external_data_server` 只保存到文件系统

3. **数据处理能力**
   - `japan_server` 有完整的数据清洗、验证、异常检测功能
   - `external_data_server` 只是简单的文件存储

4. **元数据支持**
   - `japan_server` 支持完整的元数据（batch_id, pool_id, ts_utc等）
   - `external_data_server` 没有元数据支持

5. **接口设计**
   - `japan_server` 的接口设计符合客户端的使用方式
   - `external_data_server` 的接口设计不符合客户端需求

### external_data_server 的作用

`external_data_server` 更像是一个：
- **文件存储服务**
- **数据中转服务**
- **临时数据存储服务**

它可能用于：
- 数据备份
- 文件上传下载
- 其他业务功能（用户、会话、任务等）

### 建议

1. **使用 `japan_server` 作为主要的数据接收服务端**
   - 与客户端完全匹配
   - 有完整的数据处理能力
   - 直接存储到数据库

2. **`external_data_server` 可以作为辅助服务**
   - 用于文件存储
   - 用于数据备份
   - 用于其他业务功能

3. **如果需要统一数据接收**
   - 可以考虑在 `external_data_server` 中添加数据转发功能
   - 将接收的数据转发到 `japan_server`
   - 或者直接使用 `japan_server` 作为唯一的数据接收服务端

## 总结

| 项目 | 定位 | 数据存储 | 数据处理 | 与客户端匹配 | 数据格式 |
|------|------|----------|----------|--------------|----------|
| **external_data_server** | 文件存储/旧格式服务 | 文件系统/数据库 | 基础 | ❌ 不匹配 | 旧格式（中文） |
| **japan_server** | 数据接收服务端 | 数据库 | 完整 | ✅ 完全匹配 | 新格式（标准化） |

**结论：`japan_server` 是真正的数据接收服务端，应该使用它来接收客户端发送的数据。**

### 详细说明

1. **`external_data_server`**：
   - 有两个接口：`/api/transfer_data`（文件存储）和 `/api/updata_sensor_data`（数据库存储）
   - `/api/updata_sensor_data` 使用旧的数据格式（中文字段名）
   - 与客户端 `ai_japan` 的新格式不匹配
   - 缺少元数据支持（batch_id, pool_id, ts_utc等）

2. **`japan_server`**：
   - 有完整的RESTful API接口
   - 使用新的标准化数据格式
   - 完全匹配客户端 `ai_japan` 的发送格式
   - 支持完整的元数据和数据清洗功能

**建议：使用 `japan_server` 作为主要的数据接收服务端。**
